- en: P5：Lynn Root - Advanced asyncio - Solving Real-world Production Problems - PyCon
    20 - leosan - BV1qt411g7JH
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: P5：Lynn Root - 高级异步IO - 解决真实世界的生产问题 - PyCon 20 - leosan - BV1qt411g7JH
- en: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_0.png)'
  id: totrans-1
  prefs: []
  type: TYPE_IMG
  zh: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_0.png)'
- en: hello everyone how's everyone doing come，hello everyone how's everyone doing
    come。on I need more energy this is only day，on I need more energy this is only
    day，two，two。come on all right we've got a great talk，come on all right we've got
    a great talk。this is advanced async IO solving，this is advanced async IO solving。
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 大家好，大家过得怎么样？我需要更多的能量，这只是第二天，来吧！我们有一场精彩的演讲，这是关于高级异步IO解决方案的。
- en: real-world production problems by Lind，real-world production problems by Lind。root
    Lynn has requested that if you have，root Lynn has requested that if you have。any
    questions please hold off and she，any questions please hold off and she。can answer
    those questions in the hall，can answer those questions in the hall。
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: Lynn根本在讨论真实世界的生产问题，她要求如果有任何问题，请先等一下，她会在走廊上回答这些问题。
- en: after the talk so without further ado，after the talk so without further ado，Lynne
    drew thank you。Lynne drew thank you，the jam-packed room I feel like a lot of。the
    jam-packed room I feel like a lot of，people have some real-world problems to。people
    have some real-world problems to，solve so my name is Lynne root and。
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 演讲结束后，不多说了，谢谢Lynne，坐满了人的房间让我感觉到很多人有一些现实世界的问题需要解决。我叫Lynne Root。
- en: solve so my name is Lynne root and，forgive me I have to do this because I'm。forgive
    me I have to do this because I'm，kind of a nerd happy may the fourth be。kind of
    a nerd happy may the fourth be，with you and so I'm a staff engineer at。with you
    and so I'm a staff engineer at，Spotify for the past few months I've。
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 我叫Lynne Root，请原谅我这样做，因为我有点儿书呆子气，祝大家“5月4日快乐”。我是Spotify的员工工程师，这几个月我一直在构建基础设施，以支持一些机器学习模型进行数字信号处理，这非常有趣。
- en: Spotify for the past few months I've，been building infrastructure to help。been
    building infrastructure to help，support those that do some like machine。support
    those that do some like machine，learning models to do digital signal。learning
    models to do digital signal，processing so that's quite interesting。
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 这几个月我在Spotify构建基础设施，以帮助那些进行机器学习模型的人员进行数字信号处理，这非常有趣。
- en: processing so that's quite interesting，quite fun，quite fun，I'm also fossa Vangelis
    at Spotify I。I'm also fossa Vangelis at Spotify I，help folks release their code
    under the。help folks release their code under the，Spotify github organization
    and then you。Spotify github organization and then you，might know me from PI ladies
    as well and。
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 处理数字信号非常有趣，十分有趣，我也是Spotify的Fossa Vangelis，帮助大家在Spotify的GitHub组织下发布他们的代码，你可能在PI女士的活动中也见过我。
- en: might know me from PI ladies as well and，if you don't know about PI ladies we
    are。if you don't know about PI ladies we are，a mentorship group for women and
    allies。a mentorship group for women and allies，in the Python community and I encourage。in
    the Python community and I encourage，you to go to our booth buy all the。
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能在PI女士的活动中认识我，如果你对PI女士不了解，我们是一个面向女性和盟友的导师小组，在Python社区中，我鼓励你们去我们的展位购买所有的。
- en: you to go to our booth buy all the，t-shirts so I don't have to take them。t-shirts
    so I don't have to take them，home，home，um so this is the agenda for today it。um
    so this is the agenda for today it，doesn't look like it but it's pretty。doesn't
    look like it but it's pretty，jam-packed we're gonna be covering some。
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 你们可以去我们的展位购买所有的T恤，这样我就不用把它们带回家了。今天的议程看起来不太像，但实际上内容非常丰富，我们将涵盖一些。
- en: jam-packed we're gonna be covering some，graceful shutdowns exception handling。graceful
    shutdowns exception handling，and threading along with testing。and threading along
    with testing，debugging and profiling and I think I'll。debugging and profiling
    and I think I'll，probably use all of my time but it will。
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 今天的内容非常充实，我们将讨论优雅的关闭、异常处理和多线程，以及测试、调试和性能分析，我想我可能会用完所有的时间，但会很有价值。
- en: probably use all of my time but it will，save the questions for the hallway。save
    the questions for the hallway，either way this presentation is pretty。either way
    this presentation is pretty，code heavy I will show this link at the。code heavy
    I will show this link at the，end as well so don't worry but the。
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 可能会用掉我所有的时间，但请将问题留到走廊上，无论如何这个演示相当，代码量很大，我会在最后展示这个链接，所以不用担心。
- en: end as well so don't worry but the，slides are there all right so let's get。slides
    are there all right so let's get，to it，to it，a sync i/o the concurrent。a sync
    i/o the concurrent，Python programmers dream the answer to。Python programmers dream
    the answer to，everyone's prayers right the module。
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 结束的时候也一样，所以不用担心，幻灯片已经准备好了，所以我们开始吧，异步I/O是并发的，Python程序员梦寐以求的答案，正是每个人的祈祷。
- en: everyone's prayers right the module，itself has a lot of layers of，itself has
    a lot of layers of。abstraction allowing developers as much，abstraction allowing
    developers as much。control as I need and are comfortable，control as I need and
    are comfortable。with simple hello world like examples，with simple hello world
    like examples。
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 每个人的祈祷正是这个模块，它本身有很多层次的抽象，允许开发者尽可能地控制，符合我的需求，并且感到舒适，像简单的“你好，世界”这样的例子。
- en: can show how simple it is but it's very，can show how simple it is but it's very。easy
    to get lulled into a false sense of，easy to get lulled into a false sense of。so
    we're led to believe that we were，so we're led to believe that we were。able to
    do a lot with the structure at a，able to do a lot with the structure at a。
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 可以展示它是多么简单，但很容易让人陷入一种虚假的安全感，所以我们被引导相信我们能够在结构上做很多事情。
- en: sink and a weight API layer some，sink and a weight API layer some。tutorials
    well great for the developer，tutorials well great for the developer。to get their
    toes wet try to illustrate，to get their toes wet try to illustrate。real-world
    examples but they're just，real-world examples but they're just。
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 有一个汇聚和加权的API层，一些教程非常适合开发者，让他们尝试实际案例，但它们只是。
- en: beefed up hello world examples，beefed up hello world examples。some even misuse
    the async i/o interface，some even misuse the async i/o interface。allowing one
    to easily fall into the，allowing one to easily fall into the。callback through
    the callback hell that，callback through the callback hell that。
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 强化版的“你好，世界”示例，有些甚至误用了异步I/O接口，让人容易陷入回调地狱中。
- en: we're familiar with and then some I get，we're familiar with and then some I
    get。you easily up and running with async i/o，you easily up and running with async
    i/o。but then you may realize that you're not，but then you may realize that you're
    not。really doing it correctly or it's not，really doing it correctly or it's not。
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 我们熟悉的内容，然后有时我会发现，你很容易就能使用异步I/O，但随后你可能会意识到你并没有真正做到正确，或者它并不是。
- en: exactly what you want or it only gets，exactly what you want or it only gets。you
    part of the way there so while some，you part of the way there so while some。tutorials
    will walk through and do it a，tutorials will walk through and do it a。lot to improve
    upon the basic like hello，lot to improve upon the basic like hello。
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 恰好是你想要的，或者它只能帮助你达到一部分，因此虽然一些教程会详细讲解并进行改进，比如“你好，世界”。
- en: world use case it might still be just，world use case it might still be just。like
    a web crawler and I'm not sure，like a web crawler and I'm not sure。about others
    but I'm not building web，about others but I'm not building web。crawlers at Spotify
    I'm sure I build a，crawlers at Spotify I'm sure I build a。
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 在实际使用中，它可能仍然只是一个网络爬虫，我不确定其他人，但我并不在Spotify构建网络爬虫，我确定我构建的是。
- en: lot of services that have have to make a，lot of services that have have to make
    a。lot of HTTP requests that should be，lot of HTTP requests that should be。non-blocking
    but these services of mine，non-blocking but these services of mine。they also need
    to react to pub/sub，they also need to react to pub/sub。
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: events to measure progress of actions，events to measure progress of actions。initiated
    from those events to handle，initiated from those events to handle。any incomplete
    action or other external，any incomplete action or other external。errors deal with
    pub/sub lease，errors deal with pub/sub lease，management and measure service level。
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: management and measure service level，indicators and then send metrics and。indicators
    and then send metrics and，sometimes I need naane sikki Oh friendly。sometimes I
    need naane sikki Oh friendly，dependencies so for me my problem got。dependencies
    so for me my problem got，difficult quickly and I'm so allow me to。
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: difficult quickly and I'm so allow me to，provide you with a real bowl example。provide
    you with a real bowl example，that actually comes from the real world。that actually
    comes from the real world，and I recently had Spotify actually a。and I recently
    had Spotify actually a，few years ago at Spotify and we built a。
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: few years ago at Spotify and we built a，service that does periodic hard restarts。service
    that does periodic hard restarts，of our entire fleet of instance。of our entire
    fleet of instance，and that's what we're gonna do here has。and that's what we're
    gonna do here has，anyone heard of that chaos monkey yeah。
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
- en: anyone heard of that chaos monkey yeah，alright so we're gonna build a service。alright
    so we're gonna build a service，called mayhem mandrel and it will listen。called
    mayhem mandrel and it will listen，for a pub/sub message and then restart a。for
    a pub/sub message and then restart a，host based off of that message and as we。
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
- en: host based off of that message and as we，build this service I'll point out some。build
    this service I'll point out some，best practices that I have learned along。best
    practices that I have learned along，the way slash traps that I've fallen。the way
    slash traps that I've fallen，into and this will essentially become。
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
- en: into and this will essentially become，the type of resource that pass Lin would。the
    type of resource that pass Lin would，have wanted about like three years ago。have
    wanted about like three years ago，and so we're gonna start off with some。and so
    we're gonna start off with some，foundational code we're gonna write a。
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: foundational code we're gonna write a，simple publisher and here's we're gonna。simple
    publisher and here's we're gonna，start we have a simple while true loop I。start
    we have a simple while true loop I，you a unique ID for each message to。you a unique
    ID for each message to，publish to our queue I want to highlight。
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
- en: publish to our queue I want to highlight，that we're not using the wait on the。that
    we're not using the wait on the，acute output of a message we're using a。acute
    output of a message we're using a，single create task because it will。single create
    task because it will，actually schedule the care routine on。
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 发布到我们的队列，我想强调的是， 我们没有使用等待来。我们没有使用等待来，消息的急性输出，我们使用了。消息的急性输出，我们使用了，单个创建任务，因为它会。单个创建任务，因为它会，实际调度协程。
- en: actually schedule the care routine on，the loop without blocking the rest of。the
    loop without blocking the rest of，the for loop，the for loop。the create task method
    returns a task，the create task method returns a task。but we essentially are using
    this as，but we essentially are using this as。
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上在循环中调度协程，而不阻塞其余的。循环中而不阻塞其余的，for循环，for循环。创建任务方法返回一个任务，创建任务方法返回一个任务。实际上我们本质上是将其作为，实际上我们本质上是将其作为。
- en: like a fire-and-forget mechanism if we，like a fire-and-forget mechanism if we。have
    the await here everything after it，have the await here everything after it。would
    be a block within this cover team，would be a block within this cover team。it isn't
    necessarily an issue for our，it isn't necessarily an issue for our。
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 像是一个“发射即忘”的机制，如果我们，像是一个“发射即忘”的机制，如果我们。这里有等待，所有之后的内容， 这里有等待，所有之后的内容。将在这个封面团队中被阻塞，
    将在这个封面团队中被阻塞。对于我们的，它不一定是个问题。
- en: current set up though it would be if we，current set up though it would be if
    we。were to limit the size of our queue we，were to limit the size of our queue
    we。would be awaiting on space to free up，would be awaiting on space to free up。but
    we will just stick with the create，but we will just stick with the create。
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 目前的设置，虽然如果我们， 目前的设置，虽然如果我们。限制队列的大小，限制队列的大小。我们将等待空间腾出， 我们将等待空间腾出。 但我们将继续使用创建，
    但我们将继续使用创建。
- en: task method so now that we have a，task method so now that we have a。publisher
    co-routine function we now，publisher co-routine function we now。need a consumer
    so this is our consumer，need a consumer so this is our consumer。for the published
    message messages it's，for the published message messages it's。
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 任务方法，所以现在我们有一个，任务方法，所以现在我们有一个。发布者协程函数，现在我们，发布者协程函数，现在我们。需要一个消费者，所以这就是我们的消费者，需一个消费者，所以这就是我们的消费者。对于发布的消息，消息是，针对发布的消息，消息是。
- en: still it's kind of similar to the，still it's kind of similar to the。publisher
    itself we do have a while true，publisher itself we do have a while true。loop but
    then we await on the q4 message，loop but then we await on the q4 message。we don't
    want to create a task out of，we don't want to create a task out of。
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 仍然有点类似于，仍然有点类似于。发布者本身我们确实有一个 while true，发布者本身我们确实有一个 while true。循环，但我们在 q4 消息上等待，
    循环，但我们在 q4 消息上等待。我们不想将其创建为任务， 我们不想将其创建为任务。
- en: queue duck yet because it doesn't really，queue duck yet because it doesn't really。make
    sense to block it makes sense to，make sense to block it makes sense to。block the
    care routine too because you，block the care routine too because you。can't really
    do much without a message，can't really do much without a message。
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 队列鸭子还没有，因为它真的，队列鸭子还没有，因为它真的。没有意义去阻塞，去阻塞它有意义，去阻塞协程也是，因为你，去阻塞协程也是，因为你。没有消息几乎无法做太多，
    没有消息几乎无法做太多。
- en: itself um I want to highlight again that，itself um I want to highlight again
    that。we're only blocking within the scope of，we're only blocking within the scope
    of。a consumed care routine and we're not，a consumed care routine and we're not。actually
    blocking the event loop or any，actually blocking the event loop or any，other，other。
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 我想再次强调的是，自己嗯。我想再次强调的是。我们仅在，范围内阻塞， 我们仅在，范围内阻塞。被消费的协程，而我们不，消费的协程，而我们不。实际上阻塞事件循环或任何，实际上阻塞事件循环或任何，其他，其他。
- en: tasks or care routines that are，tasks or care routines that are。scheduled so
    now we're going to replace，scheduled so now we're going to replace。a sync i/o
    dot sleep with a function，a sync i/o dot sleep with a function。that will restart
    a host I'm sure it，that will restart a host I'm sure it。
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 任务或协程，任务或协程。被调度，所以现在我们要替换， 被调度，所以现在我们要替换。一个 async i/o dot sleep 与一个函数， 一个 async
    i/o dot sleep 与一个函数。将重新启动一个主机，我确定它， 将重新启动一个主机，我确定它。
- en: looks like I'm just pushing the，looks like I'm just pushing the。simulation of
    i/o work to restart house，simulation of i/o work to restart house。function but
    in doing so I'm actually，function but in doing so I'm actually。able to create
    a task and out of that，able to create a task and out of that。
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 看起来我只是将I/O工作的仿真推给重启主机，功能，但这样做我实际上。功能，但这样做我实际上。能够创建一个任务，并由此。
- en: I'm therefore no longer blocking on，I'm therefore no longer blocking on。waiting
    for more messages we may also，waiting for more messages we may also。want to do
    more than one thing per，want to do more than one thing per。message for example
    in addition to，message for example in addition to。
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 因此我不再阻塞，等待更多的消息，我们也可能。等待更多的消息，我们也可能。希望每条消息处理不止一件事，例如，除了。
- en: restarting a host maybe we'd like to，restarting a host maybe we'd like to。store
    that message in a database for，store that message in a database for。potentially
    replaying later on so we'll，potentially replaying later on so we'll。make use of
    a single create task again，make use of a single create task again。
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 重启一个主机，也许我们希望将那条消息存储在数据库中，以便。重启一个主机，也许我们希望将那条消息存储在数据库中，以便可能稍后重放，因此我们将再次利用一个单独的创建任务。
- en: for saving the for the save cover team，for saving the for the save cover team。to
    be scheduled on the loop and，to be scheduled on the loop and。basically like checking
    it over to the，basically like checking it over to the。loop to execute for when
    it can so in，loop to execute for when it can so in。
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 为了保存覆盖团队的保存，需要安排在循环中，基本上像是将其转交给。需要安排在循环中，基本上像是将其转交给。循环，以便在可以时执行，因此在。
- en: this example the two tasks of restarting，this example the two tasks of restarting。and
    saving don't necessarily depend on，and saving don't necessarily depend on。one
    another and I'm completely，one another and I'm completely，sidestepping the concern
    that if we。sidestepping the concern that if we，should we start a host if we can't
    save。
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 这个例子中，重启和保存的两个任务并不一定依赖于。重启和保存的两个任务并不一定依赖于。彼此，我完全。彼此，我完全，回避了如果我们应该启动一个主机但无法保存的担忧。
- en: should we start a host if we can't save，a message but maybe you do want your。a
    message but maybe you do want your，work to happen serially maybe do not。work to
    happen serially maybe do not，want to have concurrency for some。want to have concurrency
    for some，asynchronous tasks so for this instance。
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们无法保存一条消息，是否应该启动一个主机，但也许你确实希望你的。是否应该启动一个主机，但也许你确实希望你的工作以串行方式进行，也许不。工作以串行方式进行，也许不希望某些异步任务有并发性，因此在这个实例中。
- en: asynchronous tasks so for this instance，maybe you want to restart hosts that。maybe
    you want to restart hosts that，only have an uptime of more than seven。only have
    an uptime of more than seven，days just like you should check the。days just like
    you should check the，balance of your checking account before。
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个实例中，可能你想要重启仅有七天以上正常运行时间的主机。可能你想要重启仅有七天以上正常运行时间的主机，就像你在。就像你在，检查你账户余额之前。
- en: balance of your checking account before，you actually debit it so needing code
    to。you actually debit it so needing code to，be serial to have steps or dependencies。be
    serial to have steps or dependencies，it doesn't mean that you can't be。it doesn't
    mean that you can't be，asynchronous the wait last restart date。
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 在你实际扣除之前，检查你账户余额，所以需要代码。你实际扣除之前，检查你账户余额，所以需要代码。是串行的，以便有步骤或依赖关系。这并不意味着你不能是。并不意味着你不能是，异步的等待最后重启日期。
- en: asynchronous the wait last restart date，will yield to the loop but it doesn't。will
    yield to the loop but it doesn't，mean that restart host will be the next。mean
    that restart host will be the next，thing that the loop executes it just。thing
    that the loop executes it just，allows other thing other things outside。
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 异步的等待最后重启日期，将让步于循环，但它并没有。将让步于循环，但这并不意味着重启主机将是下一个。并不意味着重启主机将是下一个，循环执行的事情只是。循环执行的事情只是，允许其他事情在外面进行。
- en: allows other thing other things outside，of that care routine to run so with
    that。of that care routine to run so with that，in mind I'm going to put all this。in
    mind I'm going to put all this，message related logic and a separate。message related
    logic and a separate，care routine so we still don't block the。
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 允许其他事物在护理程序之外运行，因此考虑到这一点，我将把所有这些消息相关的逻辑放入一个单独的护理程序，以确保我们仍然不会阻塞消息的消费。
- en: care routine so we still don't block the，consumption of messages saving a message。consumption
    of messages saving a message，didn't block restart host of needed so。didn't block
    restart host of needed so，we're going to make that a task again。we're going to
    make that a task again，and we're just going to remove the。
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的护理程序仍然不会阻塞消息的消费，保存一条消息。消息的消费保存一条消息，没有阻塞重启所需的主机。因此，我们将再次把这项任务列为任务。我们将再次把这项任务列为任务，并且我们将只是去掉。
- en: and we're just going to remove the，uptime check and a restart host，uptime check
    and a restart host。indiscriminately because Yolo so we've，indiscriminately because
    Yolo so we've。pulled a message from a queue and，pulled a message from a queue
    and。found out work based off of that message，found out work based off of that
    message。
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将只是去掉正常运行检查和重启主机，正常运行检查和重启主机。因为我们随便这样做，所以我们从队列中提取了一条消息，并根据该消息发现了工作。
- en: but now we need to perform like any，but now we need to perform like any。finalization
    work from that message so，finalization work from that message so。often with pub/sub
    technologies if you，often with pub/sub technologies if you。don't acknowledge a
    message with a，don't acknowledge a message with a。
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 但现在我们需要像处理任何消息的最终化工作，处理任何消息的最终化工作。经常在发布/订阅技术中，如果你不确认消息，若不确认消息。
- en: predefined within a predefined time，predefined within a predefined time。frame
    it will get redeliver due for a，frame it will get redeliver due for a。finalization
    task we should acknowledge，finalization task we should acknowledge。that the message
    if you should，that the message if you should，acknowledge the message so it doesn't。
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 在预定义的时间内，预定义的时间框架内，它将因一个框架而被重新投递，它将因一个框架而被重新投递。我们应该确认最终任务，应该确认最终任务。如果你应该确认消息，应该确认消息，这样它就不会。
- en: acknowledge the message so it doesn't，get redeliver to us so we currently have。get
    redeliver to us so we currently have，a two separate tasks save and restart。a two
    separate tasks save and restart，host and we want to make sure both are。host and
    we want to make sure both are，done before the message is cleaned up。
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 确认消息，这样它就不会被重新投递给我们，所以我们目前有。被重新投递给我们，所以我们目前有，两项独立的任务：保存和重启。两项独立的任务：保存和重启主机，我们希望确保两者都。
- en: done before the message is cleaned up，and we could go back to the sequential。and
    we could go back to the sequential，await since they're a very direct way to。await
    since they're a very direct way to，manipulate ordering but we can also use。manipulate
    ordering but we can also use，sort of callbacks on a completed task。
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 在消息被清理之前完成，我们可以回到顺序 await，因为这是操控顺序的非常直接的方式。但我们也可以在完成的任务上使用某种回调。
- en: sort of callbacks on a completed task，what we therefore want is somehow to。what
    we therefore want is somehow to，wrap both tasks since we have to wait on。wrap
    both tasks since we have to wait on，both and then do the cleanup and with。both
    and then do the cleanup and with，that we can make use of async it dot。
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以附加一个回调到它，然后我们可以等待完成的任务上的回调，因此我们想要的某种方式是将两项任务包裹在一起，因为我们必须等待。将两项任务包裹在一起，因为我们必须等待两者，然后进行清理，借助这个我们可以利用
    async it dot。
- en: that we can make use of async it dot，gather which returns a feature like。gather
    which returns a feature like，object and with that future like object。object and
    with that future like object，we can then attach a callback to it。we can then attach
    a callback to it，and then we can just a wait on the。
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 主机，我们希望确保两者都在消息被清理之前完成。我们可以利用 async it dot gather，这会返回一个类似于未来的对象。返回一个类似于未来的对象，借助这个未来的对象，我们可以附加一个回调到它。
- en: and then we can just a wait on the，future itself and so when we run this we。future
    itself and so when we run this we，can see that both the save care routine。can
    see that both the save care routine，and the restart care routine are。and the restart
    care routine are，complete and then the cleanup is called。
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们可以静静等待未来，当我们运行这个时，我们可以看到保存关怀例程和重启关怀例程都已完成，然后进行清理。
- en: complete and then the cleanup is called，so I personally have an allergy to。so
    I personally have an allergy to，callbacks and as well perhaps you want。callbacks
    and as well perhaps you want，the cleanup to be non-blocking，the cleanup to be
    non-blocking。so then here we can just await clean，so then here we can just await
    clean。
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 完成后进行清理，因此我个人对回调有些过敏，也许你还希望清理过程是非阻塞的。因此在这里我们可以直接等待清理。
- en: after the gather since the since it sort，after the gather since the since it
    sort。of takes care of the order of operations，of takes care of the order of operations。and
    it's so much cleaner，and it's so much cleaner，so a quick keeled er of that last。so
    a quick keeled er of that last，section async IO is pretty easy to use。
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在 gather 之后，由于它处理了操作顺序，所以这更干净。快速回顾一下最后一节，异步 IO 使用起来相当简单。
- en: section async IO is pretty easy to use，but it doesn't automatically mean that。but
    it doesn't automatically mean that，you're using it correctly you can't just。you're
    using it correctly you can't just，throw out around a sink and await。throw out
    around a sink and await，keywords around your blocking code it's。
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 异步 IO 部分使用起来相当简单，但这并不自动意味着你使用得正确。你不能仅仅在你的阻塞代码周围随便扔出一个 sink 和 await 关键字。
- en: keywords around your blocking code it's，sort of like a mental paradigm shift
    you。sort of like a mental paradigm shift you，have to think about what you can
    farm。have to think about what you can farm，out as well as what you actually still。out
    as well as what you actually still，need to be sequential，need to be sequential。
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 在你的阻塞代码周围使用关键字，这有点像一种心理范式的转变。你必须考虑你可以外包的内容，以及你实际上仍然需要顺序执行的内容。
- en: and so having steps within your code，and so having steps within your code。like
    the first a and then B and then C，like the first a and then B and then C。may seem
    like it's blocking when it's，may seem like it's blocking when it's，not sequential
    code。not sequential code，can still be asynchronous for instance I。
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 所以在你的代码中有步骤，比如先 A 然后 B 再 C，可能看起来像是阻塞的，尽管它不是顺序代码，仍然可以是异步的。例如，我可能需要打电话给我银行的客服，而我在等待接听，我可以把电话放到扬声器上。
- en: can still be asynchronous for instance I，might have to call a customer service
    of。might have to call a customer service of，my bank and I'm on hold and I can
    put。my bank and I'm on hold and I can put，that down and put it on speakerphone
    and。that down and put it on speakerphone and，then play with my super needy cat
    as I。
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 然后在我等待的同时玩弄我那只非常需要关注的猫。
- en: then play with my super needy cat as I，wait so I might be a single-threaded
    but。wait so I might be a single-threaded but，I can still sort of multitask like
    CPUs。I can still sort of multitask like CPUs，so often you'll want to you want
    your。so often you'll want to you want your，service to shut down gracefully if
    it。
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 然后在我等待的时候玩弄我那只非常需要关注的猫，尽管我可能是单线程的，但我仍然可以像 CPU 一样有点多任务处理。因此，你通常会希望你的服务能够优雅地关闭，如果它。
- en: service to shut down gracefully if it，receives a signal of some sort you'll。receives
    a signal of some sort you'll，probably want to clean up the database。probably want
    to clean up the database，connections that you have stop consuming。connections
    that you have stop consuming，messages finish the corresponding。
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 服务如果收到某种信号，应该优雅地关闭。你可能想要清理你已经打开的数据库连接，停止消费消息，完成相应的。
- en: messages finish the corresponding，current request that you have all like。current
    request that you have all like，not accepting new requests so if we。not accepting
    new requests so if we，happen to restart our own instance of。happen to restart
    our own instance of，our mayhem mandrel service we should。
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 消息完成相应的，当前请求你拥有的所有类似。当前请求你拥有的所有类似，不接受新请求，所以如果我们。不接受新请求，所以如果我们，碰巧重新启动我们自己的实例。碰巧重新启动我们自己的实例，应该清理我们的混乱服务。
- en: our mayhem mandrel service we should，essentially clean up our own mess um so。essentially
    clean up our own mess um so，here's a typical boilerplate code of。here's a typical
    boilerplate code of，getting a service running we have a。getting a service running
    we have a，queue instance and setting up the loop。
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的混乱服务，基本上应该清理我们的混乱，所以。基本上应该清理我们的混乱，所以，这里是一个典型的模板代码。这里是一个典型的模板代码，运行服务我们有一个。运行服务我们有一个，队列实例并设置循环。
- en: queue instance and setting up the loop，scheduling the publish and consume tasks。scheduling
    the publish and consume tasks，and then start and then close the event。and then
    start and then close the event，loop maybe even catch the keyboard。loop maybe even
    catch the keyboard，interrupt exception so if we've run this。
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 队列实例并设置循环，调度发布和消费任务。调度发布和消费任务，然后启动并关闭事件。然后启动并关闭事件，循环甚至可能捕捉键盘。循环甚至可能捕捉键盘，中断异常，所以如果我们运行这个。
- en: interrupt exception so if we've run this，and as is and we give it the SIGINT。and
    as is and we give it the SIGINT，signal we do see that we get into the。signal we
    do see that we get into the，accept and finally block of those two。accept and finally
    block of those two，log lines that we had but if we were to。
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 中断异常，所以如果我们运行这个，照常并给它SIGINT。照常并给它SIGINT，信号我们确实看到我们进入。信号我们确实看到我们进入，接受和最终块的那两个。接受和最终块的那两个，我们有的日志行，但如果我们要。
- en: log lines that we had but if we were to，send another signal to our program like。send
    another signal to our program like，sig term we can see that we don't reach。sig
    term we can see that we don't reach，that finally clause that we have defined。that
    finally clause that we have defined，here it should be pointed out that even。
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 我们有的日志行，但是如果我们要，发送另一个信号到我们的程序，比如。发送另一个信号到我们的程序，比如，sig term我们可以看到我们没有达到。sig term我们可以看到我们没有达到，我们定义的最终块。我们定义的最终块，这里应该指出，即使。
- en: here it should be pointed out that even，though even if we only care about the。though
    even if we only care about the，keyboard interrupt or this again to。keyboard interrupt
    or this again to，signal it could happen，signal it could happen。outside of the
    caching of exception，outside of the caching of exception。
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 这里应该指出，即使，尽管即使我们只关心。尽管即使我们只关心，键盘中断或这再次到。键盘中断或这再次到，信号它可能会发生，信号它可能会发生。异常缓存之外，异常缓存之外。
- en: potentially causing the service to end，potentially causing the service to end。up
    in incomplete or otherwise unknown，up in incomplete or otherwise unknown。State
    so instead of catching keyboard，State so instead of catching keyboard。interrupt
    let's attach a signal handler，interrupt let's attach a signal handler。
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 可能导致服务结束，可能导致服务结束。最终处于不完整或未知状态，最终处于不完整或未知状态。状态所以而不是捕捉键盘，状态所以而不是捕捉键盘。中断让我们附加一个信号处理程序，中断让我们附加一个信号处理程序。
- en: to the loop so we'll define we'll define，to the loop so we'll define we'll define。a
    shutdown care routine that is，a shutdown care routine that is，responsible for
    doing all of our。responsible for doing all of our，necessary shutdown tasks and
    here what。necessary shutdown tasks and here what，I'm doing is simulating like
    closing the。
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 到循环，所以我们将定义一个关机，关机护理例程是。关机护理例程是，负责执行我们所有的。负责执行我们所有的，必要的关机任务，这里我。必要的关机任务，这里我，正在模拟关闭。
- en: I'm doing is simulating like closing the，database connections returning the。database
    connections returning the，pub/sub messages is not acknowledged so。pub/sub messages
    is not acknowledged so，that they can be redeliver and not。that they can be redeliver
    and not，dropped，dropped，and then collecting all the outstanding。
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 我正在做的是模拟关闭数据库连接的，数据库连接返回的。数据库连接返回的，发布/订阅消息未被确认，所以。发布/订阅消息未被确认，所以，以便它们可以重新交付而不是。以便它们可以重新交付而不是，丢弃，丢弃，并收集所有未完成的。
- en: and then collecting all the outstanding，tasks its except for the shutdown task。tasks
    its except for the shutdown task，itself and then canceling them and we。itself
    and then canceling them and we，don't necessarily need to cancel the。don't necessarily
    need to cancel the，pending tasks we could just allow them。
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 然后收集所有未完成的任务，除了关闭任务本身，然后取消它们，我们不一定需要取消待处理的任务，我们可以允许它们完成。
- en: pending tasks we could just allow them，to finish as well and we may also want。to
    finish as well and we may also want，to take this opportunity to flush any。to take
    this opportunity to flush any，collective metrics so they're so that。collective
    metrics so they're so that，they're not lost so let's then add this。
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 待处理的任务我们可以允许它们完成，我们也可能想借此机会刷新任何集体指标，以免它们丢失，所以我们来添加这个。
- en: they're not lost so let's then add this，shutdown care routine to our event loop。shutdown
    care routine to our event loop，the first thing we should do is to set。the first
    thing we should do is to set，up our loop and then add the signal。up our loop and
    then add the signal，handlers that we want to respond to and。
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 所以让我们添加这个关闭护理例程到我们的事件循环，第一件事情是设置我们的循环，然后添加我们想要响应的信号处理程序。
- en: handlers that we want to respond to and，then we can remove that keyboard。then
    we can remove that keyboard，interrupt catch so running this again we。interrupt
    catch so running this again we，see that we do get to that finally。see that we
    do get to that finally，clause as well as like the whole，clause as well as like
    the whole。
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 我们想要响应的处理程序，然后我们可以移除那个键盘中断捕获，因此再次运行这个，我们终于能够到达那个子句。
- en: shutdown log lines that we see so you，shutdown log lines that we see so you。might
    be wondering which signals to，might be wondering which signals to。react to now
    and apparently there is no，react to now and apparently there is no。standard basically
    you should be aware，standard basically you should be aware。
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会想知道现在该对哪些信号做出反应，显然没有标准，基本上你应该意识到。
- en: of how you're running your service and，of how you're running your service and。handle
    it accordingly and it seems like，handle it accordingly and it seems like。it could
    get a bit messy with conflict，it could get a bit messy with conflict。conflicting
    signals especially when you，conflicting signals especially when you。
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 关于你如何运行你的服务，以及如何处理它似乎可能会有些混乱，尤其是在你遇到冲突信号时。
- en: add docker into the mix so there's，add docker into the mix so there's。another
    misleading API or a confusing，another misleading API or a confusing。API at least
    for me a sink i/o debt，API at least for me a sink i/o debt。shield now the docs
    say that it means，shield now the docs say that it means。
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 添加 Docker 到这个混合中，至少对我来说有另一个误导性的 API 或混淆的 API，一个 sink I/O 债务保护罩，现在文档说这意味着。
- en: it's a means to shutdown or to shield a，it's a means to shutdown or to shield
    a。future from being like cancellation but，future from being like cancellation
    but。if if you have a curtain that must not，if if you have a curtain that must
    not。be cancelled during shutdown async up，be cancelled during shutdown async up。
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个关闭的手段，或保护未来不被取消，但如果你有一个在关闭异步时不能取消的窗帘。
- en: that shield will not help you at all and，that shield will not help you at all
    and。this is because the tasks that that，this is because the tasks that that。async
    i/o debt shield creates gets，async i/o debt shield creates gets。included in async
    i/o dot all tasks and，included in async i/o dot all tasks and。
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 那个保护罩对你没有任何帮助，这是因为异步 I/O 债务保护罩创建的任务会被包括在异步 I/O dot all 任务中。
- en: therefore receives the cancellation，therefore receives the cancellation。signal
    just like the rest of tasks so to，signal just like the rest of tasks so to。illustrate
    really quick I have a super，illustrate really quick I have a super。simple async
    function that with a long，simple async function that with a long。
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 因此接收了取消信号，接收了取消信号。信号就像其他任务一样，因此，信号就像其他任务一样。因此，为了快速说明，我有一个超级，快速说明，我有一个超级。简单的异步函数，有一个长，简单的异步函数，有一个长。
- en: sleep and it says just done at the end，sleep and it says just done at the end。and
    we want to shield it from，and we want to shield it from，cancellation and with
    a CGI o dot shield。cancellation and with a CGI o dot shield，and so running this
    and canceling it。and so running this and canceling it，after a second we see that
    we don't。
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 睡眠，它在最后说完成，睡眠，它在最后说完成。我们想要保护它不受， 我们想要保护它不受，取消的影响，并且用一个CGI o点保护。取消的影响，并且用一个CGI
    o点保护，因此运行这个并取消它。并且运行这个并取消它，过了一秒，我们看到其实没有。
- en: after a second we see that we don't，actually get to that done line but it's。actually
    get to that done line but it's，immediately canceled and to be honest I。immediately
    canceled and to be honest I，actually could not get shield to work。actually could
    not get shield to work，under any sort，under any sort。
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 过了一秒钟，我们看到其实并没有达到那条完成的线，而是。其实并没有达到那条完成的线，而是，立刻被取消了，说实话我。立刻被取消了，说实话我，实际上无法让保护罩工作。实际上无法让保护罩工作，任何情况下，任何情况下。
- en: Sansa's so I've taken out the signal，Sansa's so I've taken out the signal。handler
    and I feel like this should work，handler and I feel like this should work。and
    running this in cancelling and after，and running this in cancelling and after。a
    second I still don't get to that done，a second I still don't get to that done。
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 桑莎，所以我已经移除了信号，桑莎，所以我已经移除了信号。处理程序，我觉得这应该可以工作，处理程序，我觉得这应该可以工作。并且在取消之后运行这个，并且在取消之后运行这个。过了一秒，我仍然没有达到那条完成的，过了一秒，我仍然没有达到那条完成的。
- en: line and try it again I thought I might，line and try it again I thought I might。have
    misinterpreted the docks so I've，have misinterpreted the docks so I've。tried canceling
    the carotene from，tried canceling the carotene from。another care routine but no
    I just I，another care routine but no I just I。
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 重新尝试这一行，我想我可能误解了文档，所以我。误解了文档，所以我，尝试从另一个任务取消胡萝卜，但不，我只是我。另一个任务取消胡萝卜，但不，我只是我。
- en: still couldn't get it to work，still couldn't get it to work，I've tried shielding
    a task from another。I've tried shielding a task from another，crew team that raises
    it a canceled。crew team that raises it a canceled，error itself but I couldn't
    get that to。error itself but I couldn't get that to，work I ran into URI one of
    the core。
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 仍然无法让它工作，仍然无法让它工作，我尝试从另一个。尝试从另一个任务中保护一个任务，团队提出了一个取消。团队提出了一个取消，错误本身，但我无法让它。错误本身，但我无法让它，工作，我碰到了URI，这是核心之一。
- en: work I ran into URI one of the core，developers of async ago and I was。developers
    of async ago and I was，complaining I was like I must be stupid。complaining I was
    like I must be stupid，but he told me that no async i/o is。but he told me that
    no async i/o is，stupid it makes me feel a little bit。
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 工作，我碰到了URI，这是核心之一，异步的开发人员，我在。异步的开发人员，我在，抱怨，我想我一定是傻。抱怨，我想我一定是傻，但他说不，异步I/O并不是。但他说不，异步I/O并不是，愚蠢，这让我感觉好一点。
- en: stupid it makes me feel a little bit，better but I still feel like I'm an。better
    but I still feel like I'm an，idiot I'm probably missing something so。idiot I'm
    probably missing something so，if someone in the crowd come to me。if someone in
    the crowd come to me，afterwards tell me what I'm doing wrong。
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 愚蠢，这让我感觉好一点，但我仍然觉得自己是个。更好，但我仍然觉得自己是个，傻瓜，我可能遗漏了什么，所以。傻瓜，我可能遗漏了什么，所以，如果人群中的某个人来找我。之后请告诉我我做错了什么。
- en: afterwards tell me what I'm doing wrong，that'd be super helpful anyways so we。that'd
    be super helpful anyways so we，don't necessarily have like nurseries to。don't
    necessarily have like nurseries to，help help us clean up after ourselves we。help
    help us clean up after ourselves we，need to be responsible and close up。
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 之后请告诉我我做错了什么，那会非常有帮助，所以我们。那会非常有帮助，所以我们，并不一定有像托儿所一样的地方。并不一定有像托儿所一样的地方，帮助我们清理自己的东西，我们。帮助我们清理自己的东西，我们，需要负责任地结束工作。
- en: need to be responsible and close up，connections the files that we've opened。connections
    the files that we've opened，respond to our outstanding requests。respond to our
    outstanding requests，basically leaving things how we found。basically leaving things
    how we found，them and doing a cleanup in a finally。
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 需要负责并关闭，我们打开的连接和文件。我们打开的连接和文件，响应我们的未完成请求。响应我们的未完成请求，基本上把事情留在我们发现时的样子。基本上把事情留在我们发现时的样子，并在finally中进行清理。
- en: them and doing a cleanup in a finally，Clause isn't enough though since a。Clause
    isn't enough though since a，signal could be sent outside of that try。signal could
    be sent outside of that try，except clause so we should do it when we。except clause
    so we should do it when we，construct the loop and we should tell。
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 它们，并在finally子句中进行清理，但这还不够，因为一个。子句还不够，因为一个，信号可能在那个try之外被发送。信号可能在那个try之外被发送，except子句，因此我们应该在构建时执行。except子句，因此我们应该在构建时执行，循环，并且我们应该告诉。
- en: construct the loop and we should tell，how the loop should be deconstructed as。how
    the loop should be deconstructed as，soon as the program gets interrupted。soon
    as the program gets interrupted，some way this ensures that all of our。some way
    this ensures that all of our，bases are covered，bases are covered。
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 循环，并且我们应该告诉，循环应该如何解构。循环应该如何解构，程序一旦被中断。程序一旦被中断，以某种方式确保我们的。以某种方式确保我们的，基础都得到覆盖，基础都得到覆盖。
- en: and finally once we once we are aware of，and finally once we once we are aware
    of。how our program should be shut down we，how our program should be shut down
    we。should know to what signals to respond，should know to what signals to respond。to
    if it's a manual script and then，to if it's a manual script and then。
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，一旦我们意识到，最后，一旦我们意识到。我们的程序应该如何关闭，我们，应该知道要对什么信号做出响应。应该知道要对什么信号做出响应。如果是手动脚本，然后，如果是手动脚本，然后。
- en: SIGINT might be fine but if it's within，SIGINT might be fine but if it's within。like
    a demonized docker container then，like a demonized docker container then。alright
    moving on to exception handling，alright moving on to exception handling。now you
    might have noticed that we have，now you might have noticed that we have。
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: SIGINT可能没问题，但如果在，SIGINT可能没问题，但如果在。像一个守护进程的docker容器中，那么，像一个守护进程的docker容器中。那么，好的，继续处理异常，好的，继续处理异常。现在你可能注意到我们有，现在你可能注意到我们有。
- en: not handled any exceptions so far so，not handled any exceptions so far so。let's
    revisit our restart host cur，let's revisit our restart host cur，routine and we're
    gonna add a。routine and we're gonna add a，super-realistic exception and so when
    we。super-realistic exception and so when we，run this we do see that that，run this
    we do see that that。
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止还没有处理任何异常，所以，到目前为止还没有处理任何异常，所以。让我们重新审视我们的重启主机，让我们重新审视我们的重启主机，例程，我们要添加一个。例程，我们要添加一个，超级真实的异常，因此当我们。超级真实的异常，因此当我们，运行这个时，我们确实看到那。运行这个时，我们确实看到那。
- en: super-serious exception was raised but，super-serious exception was raised but。that
    we also get a task except exception，that we also get a task except exception。was
    never retrieved，was never retrieved，because we don't properly handle the。because
    we don't properly handle the，result of a task when it raises what we。
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 超级严重的异常被引发，但，超级严重的异常被引发。但我们也得到了一个任务除了异常，然而，我们也得到了一个任务除了异常。永远没有被检索，因为我们没有正确处理。永远没有被检索，因为我们没有正确处理，任务引发结果时我们。
- en: result of a task when it raises what we，can do is define an exception handler。can
    do is define an exception handler，super-complicated I know and then we can。super-complicated
    I know and then we can，attach it to our loop much like the。attach it to our loop
    much like the，signal handling and so when we rerun。
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 当任务引发结果时，我们可以做的是定义一个异常处理程序。可以做的是定义一个异常处理程序，超级复杂，我知道，然后我们可以。超级复杂，我知道，然后我们可以，把它附加到我们的循环，就像信号处理一样。把它附加到我们的循环，就像信号处理一样，因此当我们重新运行。
- en: signal handling and so when we rerun，this we see that our logging of，this we
    see that our logging of。exception does happen oops and we don't，exception does
    happen oops and we don't。get that try or the task cannot be，get that try or the
    task cannot be。retrieved and so we've set exception，retrieved and so we've set
    exception。
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 信号处理，因此当我们重新运行，时，我们看到我们的异常日志。时，我们看到我们的异常日志。确实发生了，哎呀，我们没有。确实发生了，哎呀，我们没有。获得那个try或任务无法被，获得那个try或任务无法被。检索，因此我们设置了异常，检索，因此我们设置了异常。
- en: handling on the global level is like a，handling on the global level is like
    a。global default but perhaps you want to，global default but perhaps you want to。treat
    some exceptions differently for，treat some exceptions differently for。certain
    tasks so we're going to revisit，certain tasks so we're going to revisit。
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 在全局级别的处理就像是一个， 在全局级别的处理就像是一个。全局默认，但也许你想， 全局默认，但也许你想。对某些异常进行不同处理， 对某些异常进行不同处理。针对特定任务，所以我们将重新审视，
    针对特定任务，所以我们将重新审视。
- en: our handle message care routine here so，our handle message care routine here
    so。say for instance you're fine with a，say for instance you're fine with a。logging
    when the save message fails but，logging when the save message fails but。you want
    to nak the pub side message and，you want to nak the pub side message and。
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的消息处理常规在这里，比如， 我们的消息处理常规在这里，比如。假设你对于保存消息失败的记录没问题，但， 假设你对于保存消息失败的记录没问题，但。你想要拒绝发布方消息，并且，
    你想要拒绝发布方消息，并且。
- en: go and have it go back to the queue to，go and have it go back to the queue to。restart
    to retry the whole message so，restart to retry the whole message so。with them
    since async i/o gather returns，with them since async i/o gather returns。results
    in a deterministic way we can，results in a deterministic way we can。
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 去把它放回队列，去， 去把它放回队列，去。重新启动以重试整个消息，所以， 重新启动以重试整个消息，所以。由于 async i/o gather 返回，
    由于 async i/o gather 返回。以确定的方式返回结果，我们可以， 以确定的方式返回结果，我们可以。
- en: have a more fine-grain exception Handler，have a more fine-grain exception Handler。and
    attach the results as we wish or，and attach the results as we wish or。handle the
    results as we wish so I want，handle the results as we wish so I want。to highlight
    that setting the return，to highlight that setting the return。
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 拥有一个更细粒度的异常处理器， 拥有一个更细粒度的异常处理器。并根据我们的意愿附加结果， 并根据我们的意愿附加结果。或者根据我们的意愿处理结果，所以我想，或者根据我们的意愿处理结果，所以我想。强调设置返回的，强调设置返回的。
- en: exceptions to true is like super，exceptions to true is like super。imperative
    otherwise exceptions will be，imperative otherwise exceptions will be。handled by
    the default handler and if，handled by the default handler and if。the default Heller
    isn't set they'll，the default Heller isn't set they'll。
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 对于真正的异常就像是超类，真正的异常就像是超类。否则，命令式将会产生异常，否则，命令式将会产生异常。由默认处理器处理，如果，默认处理器处理，如果。默认处理器未设置，它们将会，默认处理器未设置，它们将会。
- en: just get swallowed and it's kind of，just get swallowed and it's kind of。confusing
    so I guess be sure to set some，confusing so I guess be sure to set some。sort of
    exception handling either，sort of exception handling either。globally or individually
    or you probably，globally or individually or you probably。
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 只是被吞没了，这有点， 只是被吞没了，这有点。混淆，所以我想确保设置一些， 混淆，所以我想确保设置一些。某种异常处理， 无论是全局的还是单独的，或者你可能，
    无论是全局的还是单独的，或者你可能。
- en: want a mix otherwise exceptions may go，want a mix otherwise exceptions may go。unnoticed
    or cause some weird behavior I，unnoticed or cause some weird behavior I。personally
    like async IO dot gather，personally like async IO dot gather。because of the order
    of return results，because of the order of return results。
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 想要一种混合，否则异常可能会，想要一种混合，否则异常可能会。被忽视或导致一些奇怪的行为，我， 被忽视或导致一些奇怪的行为，我。个人喜欢 async IO
    dot gather，个人喜欢 async IO dot gather。因为返回结果的顺序，因返回结果的顺序。
- en: it is deterministic but it's easy to，it is deterministic but it's easy to。sort
    of get tripped up with it by，sort of get tripped up with it by，default it will
    swallow sort of。default it will swallow sort of，exceptions and then happily continue。exceptions
    and then happily continue，working on the other tasks that it was。
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 它是确定性的，但很容易， 它是确定性的，但很容易。由于默认设置，可能会出现问题，默认情况下它会吞噬某些异常。默认情况下它会吞噬某些异常，然后快乐地继续，处理其他任务。
- en: working on the other tasks that it was，given so if an exception is never。given
    so if an exception is never，all right sometimes you need to work。all right sometimes
    you need to work，with threads and I'm sorry if you do so。with threads and I'm
    sorry if you do so，maybe you have like a threaded pub/sub。
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 在给定的其他任务上工作，所以如果发生异常，那就， 在给定的其他任务上工作，所以如果发生异常，那就。好吧，有时你需要使用线程， 好吧，有时你需要使用线程，抱歉如果你这样做。抱歉如果你这样做，也许你有像是线程的
    pub/sub。
- en: maybe you have like a threaded pub/sub，client and you，client and you。to consume
    a message on one thread and，to consume a message on one thread and。then handle
    the message on the care，then handle the message on the care。routine with a curtain
    on your main，routine with a curtain on your main。
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 也许你有一个线程的发布/订阅，客户端和你，客户端和你。要在一个线程上消费消息，并， 要在一个线程上消费消息，并。然后在你的主例程上处理消息， 然后在你的主例程上处理消息。
- en: event loop so let's first attempt to use，event loop so let's first attempt to
    use。the async i/o API that we're familiar，the async i/o API that we're familiar。with
    and update our synchronous callback，with and update our synchronous callback。function
    with creating a task via a，function with creating a task via a。
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 事件循环，所以让我们首先尝试使用，事件循环，所以让我们首先尝试使用。我们熟悉的异步I/O API，我们熟悉的异步I/O API。并更新我们的同步回调，
    并更新我们的同步回调。通过创建一个任务更新函数， 通过创建一个任务更新函数。
- en: single create task and create a task out，single create task and create a task
    out。of handle message so then this is how we，of handle message so then this is
    how we。would call a via the thread pool，would call a via the thread pool。executor
    very similar to synchronous，executor very similar to synchronous。
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 单一创建任务并从处理消息中创建任务，所以这就是我们， 从处理消息中创建任务，所以这就是我们。通过线程池执行器调用， 通过线程池执行器调用。非常类似于同步，
    非常类似于同步。
- en: functions but you can see that we，functions but you can see that we。actually
    don't get very far and at this，actually don't get very far and at this。point we
    are in another thread and then，point we are in another thread and then。there's
    no running event loop in that，there's no running event loop in that。
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 函数，但你可以看到我们， 函数，但你可以看到我们。实际上并没有走得太远，此时我们处于另一个线程中，然后， 此时我们处于另一个线程中，然后。没有正在运行的事件循环，
    没有正在运行的事件循环。
- en: so if we take what we have right now and，so if we take what we have right now
    and。update our function to use the main，update our function to use the main。event
    loop if we try running this it，event loop if we try running this it。looks like
    it works but it's actually，looks like it works but it's actually。
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 所以如果我们拿现在拥有的， 所以如果我们拿现在拥有的。并更新我们的函数以使用主事件循环， 并更新我们的函数以使用主事件循环。如果我们尝试运行这个，看起来正常，但实际上，
    如果我们尝试运行这个，看起来正常，但实际上。
- en: deceptive we're not being thread safe so，deceptive we're not being thread safe
    so。we're gonna try this again，we're gonna try this again，so instead of a loop
    dot create task。so instead of a loop dot create task，we're gonna make use of the
    thread safe。we're gonna make use of the thread safe，API that should give us a
    clue right so。
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 具有误导性，我们并没有线程安全，所以， 具有误导性，我们并没有线程安全。所以我们将再试一次， 所以我们将再试一次，所以不使用循环点创建任务。 所以不使用循环点创建任务，我们将利用线程安全。
    我们将利用线程安全的API，应该给我们一个线索。
- en: API that should give us a clue right so，we're gonna use a run care routine。we're
    gonna use a run care routine，thread safe and now it can be difficult。thread safe
    and now it can be difficult，to tell when you're not being thread。to tell when
    you're not being thread，safe particularly when it looks looks。
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: API应该给我们一个线索，所以我们将使用运行保养例程。我们将使用运行保养例程，线程安全，现在可能会很困难。线程安全，现在可能会很困难，判断何时不处于线程安全状态。判断何时不处于线程安全状态，特别是当它看起来正常时。
- en: safe particularly when it looks looks，like it works like it did in our。like
    it works like it did in our，previous attempt but in a bit I'll show。previous attempt
    but in a bit I'll show，you how easy how you can easily surface。you how easy how
    you can easily surface，and the issue of thread safety so I。
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 特别是当它看起来像，它正常工作时。看起来它像我们之前的尝试那样工作，但稍后我会向你展示， 看起来它像我们之前的尝试那样工作，但稍后我会向你展示。你如何轻松发现线程安全问题，因此我，
    你如何轻松发现线程安全问题，因此我。
- en: and the issue of thread safety so I，guess in my opinion it's not like too。guess
    in my opinion it's not like too，difficult to work with threaded code and。difficult
    to work with threaded code and，async i/o it's similar to how we work。async i/o
    it's similar to how we work，with non async code in the async world。
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 线程安全问题，所以在我看来， 我认为它并不是像太困难与线程代码一起工作。困难与线程代码一起工作，异步I/O和我们如何在异步世界中工作类似。 异步I/O和我们如何在异步世界中工作类似。
- en: with non async code in the async world，we'll make use of like the thread pool。we'll
    make use of like the thread pool，executor which essentially creates an。executor
    which essentially creates an，avoidable for us however it can be。avoidable for
    us however it can be，difficult in the sense of when you need。
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 在异步世界中使用非异步代码，我们将利用线程池等。我们将利用线程池等，执行器基本上创建一个。执行器基本上创建一个，对我们来说是可以避免的，但在某些情况下它可能会很。对我们来说是可以避免的，但在某些情况下它可能会很困难，当你需要的时候。
- en: difficult in the sense of when you need，to share state between both of them
    and。to share state between both of them and，when you want the thread to schedule。when
    you want the thread to schedule，something on the main event loop so if。something
    on the main event loop so if，you must do that then use the thread。
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 在某种意义上很困难，当你需要在它们之间共享状态时。共享状态在它们之间，当你希望线程调度。希望线程调度，某些事情在主事件循环上，因此如果。某些事情在主事件循环上，因此如果你必须这样做，那么使用线程。
- en: you must do that then use the thread，safe API is that async i/o gives you and。safe
    API is that async i/o gives you and，I will admit it took an embarrassing。I will
    admit it took an embarrassing，long time for me to realize this had。long time for
    me to realize this had，services already in production it was。
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 你必须这样做，那么使用线程，安全 API 是异步 I/O 为你提供的。安全 API 是异步 I/O 为你提供的，我承认我花了一个尴尬的。承认我花了一个尴尬的，长时间才意识到这在。长时间才意识到这在生产中已经有服务了。
- en: services already in production it was，so onto testing and so for a more。so onto
    testing and so for a more，simplistic starting point and we're。simplistic starting
    point and we're，going to test async i/o code before we。going to test async i/o
    code before we，introduced threading and so we're gonna。
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 生产中已经有服务了，因此进入测试，因此对于一个更。进入测试，因此对于一个更简单的起点，我们将。简单的起点，我们将测试异步 I/O 代码，然后我们。测试异步
    I/O 代码，然后我们引入线程，因此我们将。
- en: introduced threading and so we're gonna，start simple we're gonna test the save。start
    simple we're gonna test the save，care routine function using PI test。care routine
    function using PI test，since the save care team we need to is a。since the save
    care team we need to is a，curtain we need to run it in our event。
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 引入了线程，因此我们将简单开始，我们将测试保存。简单开始，我们将测试保存，关心例程函数使用 PI 测试。关心例程函数使用 PI 测试，因为我们需要的保存关心团队是一个。因为我们需要的保存关心团队是一个，我们需要在我们的事件中运行它。
- en: curtain we need to run it in our event，loop like so and which Python 3：7 that。loop
    like so and which Python 3：7 that，makes it easy for us with the async i/o。makes
    it easy for us with the async i/o，dot run function older python versions。dot run
    function older python versions，python 3 versions we'll have to。
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 我们需要在事件循环中运行的帷幕，像这样，并且 Python 3:7。像这样，并且 Python 3:7，使我们在异步 I/O 中更容易。使我们在异步 I/O
    中更容易，点运行函数在旧的 Python 版本。点运行函数在旧的 Python 版本，Python 3 版本我们必须。
- en: python 3 versions we'll have to，construct and deconstruct the loop。construct
    and deconstruct the loop，yourself but some of you might be saying。yourself but
    some of you might be saying，there's a better way and there is there。there's a
    better way and there is there，is a PI test plugin called PI test -。
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: Python 3 版本我们必须，构造和拆解循环。构造和拆解循环，自己但是你们中的一些人可能会说。自己但是你们中的一些人可能会说，有更好的方法，确实如此。更好的方法，确实如此，有一个
    PI 测试插件称为 PI 测试 -。
- en: is a PI test plugin called PI test -，async i/o that will essentially do that。async
    i/o that will essentially do that，the hard work for you you just need to。the hard
    work for you you just need to，mark the particular tests that they are。mark the
    particular tests that they are，async code that needs to be run with。
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 有一个 PI 测试插件称为 PI 测试 -，异步 I/O 本质上会做到这一点。异步 I/O 本质上会做到这一点，为你完成艰难的工作，你只需要。为你完成艰难的工作，你只需要标记这些特定的测试，它们是。标记这些特定的测试，它们是需要使用的异步代码。
- en: async code that needs to be run with，this decorator and you need to make the。this
    decorator and you need to make the，test function itself a care team now。test function
    itself a care team now，when running the tests the plug-in will。when running the
    tests the plug-in will，essentially do the work for you of。
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 需要使用这个装饰器运行的异步代码，你需要使。这个装饰器，你需要使测试函数本身成为一个关心团队。测试函数本身成为一个关心团队，现在在运行测试时，插件将。现在在运行测试时，插件将本质上为你完成工作。
- en: essentially do the work for you of，constructing and deconstructing the。constructing
    and deconstructing the，event the event loop so the PI test。event the event loop
    so the PI test，async i/o plug-in can get you pretty far。async i/o plug-in can
    get you pretty far，but it doesn't help you when you need to。
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 本质上为你完成构造和解构的工作，构造和解构的工作，事件循环，因此 PI 测试。事件循环，因此 PI 测试，异步 I/O 插件可以让你走得很远。异步 I/O
    插件可以让你走得很远，但在你需要的时候，它并没有帮助你。
- en: but it doesn't help you when you need to，mock out co-routines for instance our。mock
    out co-routines for instance our，save care routine function calls another。save
    care routine function calls another，care routine the async i/o dot sleep or。care
    routine the async i/o dot sleep or，might actually call a database now you。
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 但在你需要的时候，它并没有帮助你，模拟协程，比如我们的。模拟协程，比如我们的保存关心例程函数调用另一个。保存关心例程函数调用另一个，关心例程的异步 I/O
    睡眠或者。关心例程的异步 I/O 睡眠，可能实际上会调用一个数据库。
- en: might actually call a database now you，don't actually want to wait for async
    IO。don't actually want to wait for async IO，dot sleep to complete while you're。dot
    sleep to complete while you're，running the tests or do you actually。running the
    tests or do you actually，want to call a database while you're。
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你可能实际上会调用一个数据库，你**不想**等待异步 I/O。你**不想**等待异步 I/O，等待完成时你正在。等待完成时你正在，运行测试，或者你**真的**想在运行时调用一个数据库。
- en: want to call a database while you're，running your tests and so both the unit。running
    your tests and so both the unit，tests mock library and the PI test -。tests mock
    library and the PI test -，mock package do not support asynchronous。mock package
    do not support asynchronous，mocks so we'll sort of have to work。
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 你**想要**在运行测试时调用一个数据库，因此单元。你**想要**在运行测试时调用一个数据库，因此单元测试模拟库和 PI 测试 - 测试模拟库以及 PI
    测试 - 模拟包不支持异步。模拟包不支持异步，模拟，因此我们有点需要工作。
- en: mocks so we'll sort of have to work，around this and we are going to make use。around
    this and we are going to make use，of the PI test mock lot library and。of the PI
    test mock lot library and，create a fixture，create a fixture。now that's essentially
    returning a，now that's essentially returning a。
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 模拟，因此我们有点需要绕过这一点，我们将利用。绕过这一点，我们将利用 PI 测试模拟库并创建一个夹具，创建一个夹具。现在本质上是返回一个，现在本质上是返回一个。
- en: function so the outer function that，function so the outer function that。returns
    this inner function as a fixture，returns this inner function as a fixture。that
    will end up using inner tests and，that will end up using inner tests and。then
    the inner function is basically，then the inner function is basically。
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 函数，因此外部函数返回这个内部函数作为夹具，返回这个内部函数作为夹具。它将最终使用内部测试，并且它将最终使用内部测试。然后这个内部函数基本上， 然后这个内部函数基本上。
- en: creating and returning a mock object，creating and returning a mock object。that
    we will play with in our tests，that we will play with in our tests。as well as
    a stubbed co-routine that，as well as a stubbed co-routine that。will actually end
    up getting called and，will actually end up getting called and。
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 创建和返回一个模拟对象，创建和返回一个模拟对象。我们将在测试中使用它，我们将在测试中使用它。以及一个存根协程，作为一个存根协程。最终会被调用，并且最终会被调用。
- en: then it will call our mock for us it，then it will call our mock for us it。also
    patches if we need the desired care，also patches if we need the desired care。routine
    with the stub so we can avoid，routine with the stub so we can avoid。the network
    calls the sleeps that we，the network calls the sleeps that we。
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 然后它会为我们调用我们的模拟，它会为我们调用我们的模拟。如果我们需要期望的关心，它也会打补丁。如果我们需要期望的关心，它也会打补丁。通过存根的例程，这样我们就可以避免，通过存根的例程，这样我们就可以避免。网络调用是我们需要的睡眠，网络调用是我们需要的睡眠。
- en: don't want to happen so then we're going，don't want to happen so then we're
    going。to create another PI test fixture that，to create another PI test fixture
    that。will use this create co-op fixture that，will use this create co-op fixture
    that。we just defined to mock and patch the，we just defined to mock and patch the。
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 你**不想**发生这种情况，所以我们将，**不想**发生这种情况，所以我们将创建另一个 PI 测试夹具，创建另一个 PI 测试夹具。将使用我们刚刚定义的这个创建协作夹具，
    将使用我们刚刚定义的这个创建协作夹具，以模拟和打补丁。
- en: async i/o dot sleep and we don't need，async i/o dot sleep and we don't need。the
    stub care routine that is returned，the stub care routine that is returned。so we
    can just sort of throw that away，so we can just sort of throw that away。and then
    we can use the mock sleep，and then we can use the mock sleep。
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 异步 i/o 点 sleep，我们不需要， 异步 i/o 点 sleep，我们不需要。返回的存根关心例程， 返回的存根关心例程。因此我们可以将其抛弃，
    因此我们可以将其抛弃。然后我们可以使用模拟的 sleep， 然后我们可以使用模拟的 sleep。
- en: fixture in our test save function so，fixture in our test save function so。what
    we've done is basically patched a，what we've done is basically patched a。sync
    i/o dot sleep in our mayhem module，sync i/o dot sleep in our mayhem module。with
    the a stub co-routine function and，with the a stub co-routine function and。
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们测试保存函数中的夹具， 在我们测试保存函数中的夹具。我们所做的基本上是修补， 我们所做的基本上是修补。sync i/o 点 sleep 在我们的混乱模块中，
    sync i/o 点 sleep 在我们的混乱模块中。与一个存根协程函数一起， 与一个存根协程函数一起。
- en: then we can assert the mock mock to，then we can assert the mock mock to。Isengard
    that sleep object was called，Isengard that sleep object was called。once the mayhem
    dot save care routine，once the mayhem dot save care routine。was called because
    we now have a mock，was called because we now have a mock。
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们可以断言模拟 mock 到， 然后我们可以断言模拟 mock 到。Isengard 那个 sleep 对象被调用， Isengard 那个 sleep
    对象被调用。一次当 mayhem 点 save 关心例程， 一次当 mayhem 点 save 关心例程。被调用，因为我们现在有一个模拟， 被调用，因为我们现在有一个模拟。
- en: object instead instead of the actual，object instead instead of the actual。care
    routine we can now do anything，care routine we can now do anything。that's supported
    with mocks we can do，that's supported with mocks we can do。assert called once
    with and play with，assert called once with and play with。
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 对象而不是实际的， 对象而不是实际的。关心例程我们现在可以做任何， 关心例程我们现在可以做任何。支持模拟的操作我们可以， 支持模拟的操作我们可以。断言被调用一次并玩，
    断言被调用一次并玩。
- en: the return values and side effects as we，the return values and side effects
    as we。need etc remind you when I'm testing I，need etc remind you when I'm testing
    I。do tests with to assert that parameters，do tests with to assert that parameters。were
    called as accordingly and not just，were called as accordingly and not just。
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 返回值和副作用我们， 返回值和副作用我们。需要等提醒你，当我测试时，我， 需要等提醒你，当我测试时，我。进行测试以断言参数， 进行测试以断言参数。是按照相应的调用，而不仅仅是，
    是按照相应的调用，而不仅仅是。
- en: the simple count thing so that's simple，the simple count thing so that's simple。enough
    but sometimes you need to test，enough but sometimes you need to test。code that
    is using the create task，code that is using the create task。method and we can't
    simply use the，method and we can't simply use the。
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 简单的计数事情，所以这很简单， 简单的计数事情，所以这很简单。足够简单，但有时你需要测试， 足够简单，但有时你需要测试。使用创建任务的方法的代码， 使用创建任务的方法的代码。我们不能简单地使用，
    我们不能简单地使用。
- en: create curve or mock fixture that we，create curve or mock fixture that we，defined
    a second ago。defined a second ago，so for instance let's revisit our，so for instance
    let's revisit our。consume Co routine and this which will，consume Co routine and
    this which will。create and schedule a task on the loop，create and schedule a task
    on the loop。
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 创建曲线或模拟夹具，我们， 创建曲线或模拟夹具，我们。刚刚定义了一个秒前， 刚刚定义了一个秒前。因此，比如让我们重新审视我们的， 因此，比如让我们重新审视我们的。消费协程，而这将，
    消费协程，而这将。创建并在循环上调度一个任务， 创建并在循环上调度一个任务。
- en: and it will pass the handle message care，and it will pass the handle message
    care。routine so first need a couple of，routine so first need a couple of。fixtures
    for that Q we will mock and，fixtures for that Q we will mock and。patch the async
    a OQ class within our，patch the async a OQ class within our。
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 并且它会传递处理消息的关心， 并且它会传递处理消息的关心。首先需要几个例程，首先需要几个例程。我们将为该 Q 创建模拟， 我们将为该 Q 创建模拟。修补我们异步的
    OQ 类， 修补我们异步的 OQ 类。
- en: module and then we'll use the mock Q，module and then we'll use the mock Q。fixture
    in another one in the mock get，fixture in another one in the mock get。fixture
    and so unlike our mock sleep，fixture and so unlike our mock sleep。fixture we will
    use that stub care，fixture we will use that stub care。
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 模块，然后我们将在另一个中使用模拟 Q， 模块，然后我们将在另一个中使用模拟 Q。夹具在模拟获取中， 夹具在模拟获取中。与我们的模拟 sleep 夹具不同，
    与我们的模拟 sleep 夹具不同。我们将使用那个存根关心， 我们将使用那个存根关心。
- en: routine that create mock Co returns and，routine that create mock Co returns
    and。so here is our test consume function，so here is our test consume function。where
    we are giving the newly created，where we are giving the newly created。fixtures
    and so we will try to use the，fixtures and so we will try to use the。
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 创建模拟Co返回的例程，以及创建模拟Co返回的例程。所以这是我们的测试消费函数，所以这是我们的测试消费函数。我们正在提供新创建的，我们正在提供新创建的。装置，所以我们会尝试使用这些，装置，所以我们会尝试使用这些。
- en: create coder mock to mock and patch the，create coder mock to mock and patch
    the。call to a handle message carotene a via，call to a handle message carotene
    a via。that create task and I want to highlight，that create task and I want to
    highlight。that we're setting the mock get，that we're setting the mock get。
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 创建编码器模拟以模拟和修补，创建编码器模拟以模拟和修补。对处理消息的调用，通过，处理消息的调用，通过。创建任务，我想强调，创建任务，我想强调。我们正在设置模拟获取，正在设置模拟获取。
- en: side-effect to one real value and one，side-effect to one real value and one。exception
    to make sure that we're not，exception to make sure that we're not。permanently
    stuck in that while true，permanently stuck in that while true。loop that the consume
    has and finally we，loop that the consume has and finally we。
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 侧效应变为一个真实值和一个，侧效应变为一个真实值和一个。异常，以确保我们不会，异常，以确保我们不会。永远卡在那个while true，永远卡在那个while
    true。消费的循环中，最后我们，消费的循环中，最后我们。
- en: want to assert that our mock for handle，want to assert that our mock for handle。message
    has been called after consume，message has been called after consume。has been running
    so when running this we，has been running so when running this we。see that mock
    handle message does not，see that mock handle message does not。
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 想要断言我们的模拟处理，想要断言我们的模拟处理。消息在消费后被调用，消息在消费后被调用。正在运行，所以运行这个时，我们，正在运行，所以运行这个时。看到模拟处理消息没有，看到模拟处理消息没有。
- en: actually get called like we were，actually get called like we were。expecting
    and this is because these，expecting and this is because these。scheduled tasks
    are only scheduled and，scheduled tasks are only scheduled and。pending at this
    point we sort of have to，pending at this point we sort of have to。
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上没有被调用，就像我们，实际上没有被调用，就像我们。期待的，这因为这些，期待的，这因为这些。调度的任务仅仅是调度和，调度的任务仅仅是调度和。此时待处理，我们在某种程度上必须，待处理，我们在某种程度上必须。
- en: nudge them along and so to do this and，nudge them along and so to do this and。we
    kind of collect all the running tasks，we kind of collect all the running tasks。except
    for the test itself and then it's，except for the test itself and then it's。run
    this explicitly I know this is a bit，run this explicitly I know this is a bit。
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 促使他们向前推进，因此这样做，我们有点收集所有正在运行的任务，促使他们向前推进，因此这样做。除了测试本身，然后它是，除了测试本身，然后它是。显式运行这个，我知道这有点，显式运行这个，我知道这有点。
- en: clunky perhaps this isn't an opportunity，clunky perhaps this isn't an opportunity。to
    contribute to PI test during a，to contribute to PI test during a。sprints but if
    you use the yes the，sprints but if you use the yes the。standard the unit test
    a library from，standard the unit test a library from。
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 笨拙，或许这不是一个机会，笨拙，或许这不是一个机会。为PI测试做贡献，在一次，贡献给PI测试，在一次。冲刺中，但如果你使用，是的，冲刺中，但如果你使用，是的。标准的单元测试库，来自，标准的单元测试库，来自。
- en: the standard library there's a package，the standard library there's a package。called
    async test that handles this and，called async test that handles this and。it's
    a bit better and it exhausts the，it's a bit better and it exhausts the。scheduling
    of tasks for you so I hear，scheduling of tasks for you so I hear。
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 标准库中有一个包，标准库中有一个包。叫做async test，处理这个问题，它，叫做async test，处理这个问题，它。稍微好一些，并且会耗尽，稍微好一些，并且会耗尽。任务调度，所以我听说，任务调度，所以我听说。
- en: that you're wanting to get 100% test，that you're wanting to get 100% test。coverage
    just like me which can be，coverage just like me which can be。difficult for our
    main function so we，difficult for our main function so we。set up the signal handling
    and exception，set up the signal handling and exception。
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 你想要获得100%的测试覆盖率，就像我一样，这可能是，覆盖率就像我一样，这可能是。我们主要功能的难点，所以我们，主要功能的难点，所以我们。设置信号处理和异常，设置信号处理和异常。
- en: handling and we create a few tasks and，handling and we create a few tasks and。then
    we start and close the loop we，then we start and close the loop we。can't exactly
    use the the event loop，can't exactly use the the event loop。fixture that the PI
    test - async i/o，fixture that the PI test - async i/o。
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 处理时，我们创建一些任务，然后启动并关闭循环，我们无法确切使用 PI 测试 - 异步 I/O 的事件循环固定装置。
- en: library gives us we need to manipulate，library gives us we need to manipulate。that
    fixture that gets ends up getting，that fixture that gets ends up getting。injected
    into our code I mean do this by，injected into our code I mean do this by。updating
    the event loop so we can，updating the event loop so we can。
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 库提供了我们需要操纵的固定装置，这个固定装置最终注入到我们的代码中，我是通过更新事件循环来做到这一点。
- en: override the clothes behavior if we，override the clothes behavior if we。close
    the loop during the test we，close the loop during the test we。actually lose access
    to the exception，actually lose access to the exception。and signal handlers that
    we set up，and signal handlers that we set up。
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们在测试期间关闭循环，则覆盖关闭行为，我们实际上会失去对我们设置的异常和信号处理程序的访问。
- en: within the main function so we actually，within the main function so we actually。need
    to close when we're done with the，need to close when we're done with the。test
    and then we can use the mock to，test and then we can use the mock to。assert that
    the main function actually，assert that the main function actually，closes，closes。
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 在主函数内，我们实际上需要在完成测试后关闭它，然后可以使用模拟来断言主函数确实关闭。
- en: Loup and so we write the test main，Loup and so we write the test main。function
    that actually kind of borders，function that actually kind of borders。on an integration
    or functional test and，on an integration or functional test and。we want to make
    sure in addition to the，we want to make sure in addition to the。
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: Loup，因此我们编写实际有点类似于集成或功能测试的测试主函数，我们希望确保。
- en: expected calls to publish and consume，expected calls to publish and consume。that
    shut down gets called when expected，that shut down gets called when expected。and
    we can't exactly mock out shut down，and we can't exactly mock out shut down。with
    our create code or mock since it，with our create code or mock since it。
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 期望调用发布和消费，预期关闭在预期时被调用，但我们无法准确模拟关闭。
- en: will just patch it with another care，will just patch it with another care。routine
    and therefore run the care，routine and therefore run the care。routine every time
    a signal rather than，routine every time a signal rather than。canceling tasks in
    stopping the loop so，canceling tasks in stopping the loop so。
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 我们只需用另一个例程进行修补，因此每当信号到达时都运行该例程，而不是取消任务并停止循环。
- en: instead we mock out the shut the，instead we mock out the shut the。curtains within
    shutdown the async i/o，curtains within shutdown the async i/o。gather and then
    here I'm starting a，gather and then here I'm starting a。thread that will essentially
    send the，thread that will essentially send the。
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: '我们模拟关闭的窗帘，在异步 I/O 关闭中汇聚，然后在这里我启动一个线程，它基本上会发送。 '
- en: process a signal after a tenth of a，process a signal after a tenth of a。second
    and after starting out thread we，second and after starting out thread we。will
    then call the main function that we，will then call the main function that we，want
    to test。want to test，so this looking at the second half of，so this looking at
    the second half of。
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 在开始线程后处理信号的十分之一秒，我们将调用我们想要测试的主函数。
- en: the test we can then assert that the the，the test we can then assert that the
    the。loop is set up the way that we expected，loop is set up the way that we expected。that
    our mocked out functions have been，that our mocked out functions have been。called
    and then returning to the test，called and then returning to the test。
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 测试我们可以断言，循环设置的方式与我们预期的，设置的方式与我们预期的。我们的模拟函数已被，调用然后返回到测试中。
- en: setup real quick you can yeah you can，setup real quick you can yeah you can。you
    might want to think about，you might want to think about，parameterizing the test
    itself with not。parameterizing the test itself with not，just the second signal
    but all the。just the second signal but all the，signals that we might be expecting
    and。
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 快速设置你可以是的，你可以，可能需要考虑，参数化测试本身，而不仅仅是第二个信号，而是所有的，可能会期望的信号。
- en: signals that we might be expecting and，it's probably good to have a test of
    a。it's probably good to have a test of a，signal that you're not explicitly。signal
    that you're not explicitly，attaching the handler to like sig quit。attaching the
    handler to like sig quit，and so basically the TLDR is used pi。
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 可能期望的信号，可能最好有一个测试，一个信号，你并没有明确，附加处理程序，比如sig quit，因此基本上TLDR是使用PI。
- en: and so basically the TLDR is used pi，test async i/o there's also a package。test
    async i/o there's also a package，called async test as I mentioned before。called
    async test as I mentioned before，for the unit test library it's similar。for the
    unit test library it's similar，to PI test async i/o in that a construct。
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 所以基本上TLDR是使用PI，测试异步IO，还有一个包，叫做异步测试，正如我之前提到的，针对单元测试库，它类似于PI测试异步IO中的构造。
- en: to PI test async i/o in that a construct，or a handle the event loop instruction。or
    a handle the event loop instruction，for you but it also has the exhaustion。for
    you but it also has the exhaustion，of scheduled tasks and actually um。of scheduled
    tasks and actually um，mocking co-routines ability right there。
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在PI测试异步IO中构造，或者处理事件循环指令，给你但它也有已调度任务的消耗，实际上，模拟协程的能力就在这里。
- en: mocking co-routines ability right there，so we're pretty decent programmers and。so
    we're pretty decent programmers and，we have good code coverage but sometimes。we
    have good code coverage but sometimes，stuff breaks we need to figure out。stuff
    breaks we need to figure out，what's going on so we can use everyone's。
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 模拟协程的能力就在这里，因此我们是相当不错的程序员，代码覆盖率很好，但有时，代码会崩溃我们需要弄清楚，发生了什么，所以我们可以使用每个人的。
- en: what's going on so we can use everyone's，favorite debugger printing，favorite
    debugger printing。sort of so if you have just one small，sort of so if you have
    just one small。thing to debug it might help to use the，thing to debug it might
    help to use the。print stack method on task instance and，print stack method on
    task instance and。
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 发生了什么所以我们可以使用每个人的，最爱的调试器打印，最爱的调试器打印。因此如果你只有一个小的，事情要调试，使用，任务实例上的打印堆栈方法可能会有所帮助。
- en: so when you run this you can see that，so when you run this you can see that。the
    print attack will like you'll see，the print attack will like you'll see。the stack
    for every running task and you，the stack for every running task and you。can increase
    the number of frames that，can increase the number of frames that。
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 所以当你运行这个时，你可以看到，所打印的攻击会像你所看到的，堆栈中每个正在运行的任务，你，可以增加帧的数量，。
- en: are printed as well so async IO has a，are printed as well so async IO has a。debug
    mode actually already available，debug mode actually already available。and it's
    quite useful so along with，and it's quite useful so along with。setting our logging
    to the debug level，setting our logging to the debug level。
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 也会打印出来，因此异步IO有一个，也会打印出来，因此异步IO有一个。调试模式实际上已经可用，调试模式实际上已经可用。而且它非常有用，因此我们将，设置我们的日志记录为调试级别。
- en: we can easily turn on async I had a bug，we can easily turn on async I had a
    bug。when we run our script so say for，when we run our script so say for。instance
    we didn't have that proper，instance we didn't have that proper。exception handling
    setup we can see that，exception handling setup we can see that。
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以轻松开启异步，我曾经有个bug，当我们运行我们的脚本，比如说，当我们运行我们的脚本，比如说。实例，我们没有正确的，实例，我们没有正确的。异常处理设置，我们可以看到，异常处理设置，我们可以看到。
- en: the TAS was never achieved but we also，the TAS was never achieved but we also。get
    information about the task that it，get information about the task that it。was
    affected and what's called a source，was affected and what's called a source。trace
    back to give us more contacts in，trace back to give us more contacts in。
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: TAS从未实现，但我们也，TAS从未实现，但我们也。获取有关任务的信息，它，获取有关任务的信息，它。受到影响，并被称为源，受到影响，并被称为源。追踪以提供更多上下文，追踪以提供更多上下文。
- en: addition to the trace back so without，addition to the trace back so without。debug
    mode we get told that there is an，debug mode we get told that there is an。exception
    that's not properly handled，exception that's not properly handled。and with debug
    mode it gives us more，and with debug mode it gives us more。
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 除了追踪外，我们还被告知有一个，除了追踪外，我们还被告知有一个。调试模式下出现一个没有被妥善处理的，调试模式下出现一个没有被妥善处理的。异常，并且调试模式会给我们更多，异常，并且调试模式会给我们更多。
- en: another very handy thing wish I knew a，another very handy thing wish I knew
    a。few years ago is it's able to tell you，few years ago is it's able to tell you。if
    your thread safe so if you got the，if your thread safe so if you got the。thread
    if you got threads an event and，thread if you got threads an event and。
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 还有一件非常方便的事情，我几年前就希望知道，几年前就希望知道。它能够告诉你，是否是线程安全的，所以如果你有，是否是线程安全的，所以如果你有。线程，如果你有线程和事件，线程，如果你有线程和事件。
- en: the event loop interacting with each，the event loop interacting with each。other
    the bug mode will surface any non，other the bug mode will surface any non。thread
    safe operations for you as a，thread safe operations for you as a。runtime error
    and then one really nice，runtime error and then one really nice。
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 事件循环相互交互，事件循环相互交互。调试模式会显现出任何非，调试模式会显现出任何非。线程安全的操作作为一个，线程安全的操作作为一个。运行时错误，然后有一个非常好的，运行时错误，然后有一个非常好的。
- en: feature about debug mode in async IO is，feature about debug mode in async IO
    is。how it sort of acts like a tiny little，how it sort of acts like a tiny little。profiler
    that will log asynchronous，profiler that will log asynchronous。calls that are
    slower than 100，calls that are slower than 100。
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 异步IO中的调试模式的特点是，它有点像一个小型的，它有点像一个小型的。分析器，将记录比100慢的，分析器，将记录比100慢的。异步调用。
- en: milliseconds so we're gonna fake a slow，milliseconds so we're gonna fake a slow。care
    routine by putting a blocking call，care routine by putting a blocking call。into
    timed out sleep so then we run our，into timed out sleep so then we run our。script
    again and we can see that async，script again and we can see that async。
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 所以我们将伪造一个慢的，护理例程，通过放置一个阻塞调用，护理例程，通过放置一个阻塞调用。进入超时睡眠，然后我们再次运行我们的，进入超时睡眠，然后我们再次运行我们的。脚本，我们可以看到异步，脚本，我们可以看到异步。
- en: IO will surface slow to finish tasks，IO will surface slow to finish tasks。potentially
    highlighting any，potentially highlighting any，unnecessarily blocking tasks so
    the。unnecessarily blocking tasks so the，default for what's considered slow is。default
    for what's considered slow is，100 milliseconds but that's configurable。
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: IO会显现出慢的任务完成，IO会显现出慢的任务完成。潜在地突出任何，潜在地突出任何。不必要的阻塞任务，因此，默认的慢任务是，默认的慢任务是，100毫秒，但这是可配置的。
- en: 100 milliseconds but that's configurable，- you can set the slow callback duration。-
    you can set the slow callback duration，so much like some people's testing。so much
    like some people's testing，philosophies sometimes you need to debug。philosophies
    sometimes you need to debug，in production but usually don't want。
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 100毫秒，但这是可配置的，你可以设置慢回调的持续时间。你可以设置慢回调的持续时间，像一些人的测试。像一些人的测试，哲学有时你需要调试。哲学有时你需要调试，在生产环境中，但通常不想。
- en: in production but usually don't want，full-on debug mode while in production。full-on
    debug mode while in production，so there's a lightweight package called。so there's
    a lightweight package called，a IO debug that will log slow callbacks。a IO debug
    that will log slow callbacks，for you and it also comes with the。
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 在生产环境中，但通常不希望使用**完全调试模式**。在生产环境中使用**完全调试模式**，因此有一个轻量级的包叫做。轻量级的包叫做**IO调试**，它会记录慢回调。它会记录慢回调，为你提供信息，同时它还带有。
- en: for you and it also comes with the，ability to report delayed calls to stats。ability
    to report delayed calls to stats，D if you use that now that's the only。D if you
    use that now that's the only，thing that the mod or that the package。thing that
    the mod or that the package，will do so it's super lightweight so to。
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 为你提供的信息，同时它还具备**报告延迟调用**到统计的能力。**报告延迟调用**到统计的能力，如果你现在使用，这就是唯一的。**如果你现在使用，这就是唯一的**，模组或者包将会做的事情。模组或者包将会做的事情，因此它非常轻量，因此。
- en: will do so it's super lightweight so to，wrap up debugging you can easily print。wrap
    up debugging you can easily print，the stack of the tasks if needed but you。the
    stack of the tasks if needed but you，can also get a lot with async IOT's。can also
    get a lot with async IOT's，debug mode it gives more information。
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 非常轻量，因此总结调试，你可以轻松打印。总结调试，你可以轻松打印任务的堆栈，如果需要，但你。任务的堆栈，如果需要，但你，也可以通过**异步IOT**获得很多。也可以通过**异步IOT**获得很多，调试模式提供了更多的信息。
- en: debug mode it gives more information，around unhandled exceptions when you're。around
    unhandled exceptions when you're，not being thread safe and when they're。not being
    thread safe and when they're，slow to complete tasks and if you want。slow to complete
    tasks and if you want，to understand so to complete tasks in。
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: '**调试模式**提供了更多的信息，关于未处理的异常，当你。关于未处理的异常，当你，未线程安全并且它们。未线程安全并且它们，完成任务很慢。如果你想了解，完成任务。'
- en: to understand so to complete tasks in，production a o debug is a lightweight。production
    a o debug is a lightweight，all right so as we saw with ASIC IOT's。all right so
    as we saw with ASIC IOT's，debug mode the event loop can already。debug mode the
    event loop can already，track her routines that take up too much。
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 了解完成任务，生产环境中的**IO调试**是一个轻量级的。生产环境中的**IO调试**是一个轻量级的，好的，正如我们在**ASIC IOT**的调试模式中看到的。好的，正如我们在**ASIC
    IOT**的调试模式中看到的，事件循环已经可以。事件循环已经可以，跟踪她的例程，这些例程占用了过多的。
- en: track her routines that take up too much，CPU time to execute but it might be
    hard。CPU time to execute but it might be hard，to tell what is anomaly and what
    is a。to tell what is anomaly and what is a，pattern so folks a lot of folks might。pattern
    so folks a lot of folks might，first reach for a seat profile to try。
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 跟踪她的例程，这些例程执行时占用了过多的**CPU时间**，但这可能很困难。**CPU时间**执行时可能很困难，判断什么是异常，什么是模式，因此很多人可能。模式，因此很多人可能，首先会选择一个**座位配置**来尝试。
- en: first reach for a seat profile to try，and understand performance and we can。and
    understand performance and we can，try that out here too but there's not。try that
    out here too but there's not，much to actually glean from it I kind of。much to
    actually glean from it I kind of，snip it for the slide a little bit but。
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 首先选择一个**座位配置**来尝试，理解性能，我们可以。理解性能，我们可以，在这里也试试，但实际上没有。在这里也试试，但实际上没有什么可获得的信息，我稍微。没有什么可获得的信息，我稍微为幻灯片剪辑了一下，但。
- en: snip it for the slide a little bit but，the top item here is essentially the。the
    top item here is essentially the，event loop itself if we limit to only。event loop
    itself if we limit to only，looking at our code we kind of get a。looking at our
    code we kind of get a，picture of what's going on like we can。
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 为幻灯片稍微剪辑一下，但这里的顶部项目本质上是。顶部项目本质上是事件循环本身，如果我们限制只看。事件循环本身，如果我们限制只看我们的代码，我们大致可以得到一个。我们的代码，我们大致可以得到一个关于发生了什么的图像，我们可以。
- en: picture of what's going on like we can，see that our main function，see that our
    main function。takes up the most time but that's where，takes up the most time but
    that's where。the event loop is run is random but，the event loop is run is random
    but。nothing else is immediately obvious，nothing else is immediately obvious。
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 关于发生了什么的图像，我们可以看到我们的**主函数**，看到我们的**主函数**。占用了最多的时间，但这正是，占用了最多的时间，但这正是事件循环运行是随机的，但是。事件循环运行是随机的，但是没有其他东西是立即明显的，没有其他东西是立即明显的。
- en: so I actually recently discovered that，so I actually recently discovered that。Kay
    cash grind I don't know if you're，Kay cash grind I don't know if you're。all familiar
    with it can't be used with，all familiar with it can't be used with。Python so to
    do so we just save the，Python so to do so we just save the。
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 我最近发现 Kay cash grind，我不知道你们是否都熟悉它，它不能与 Python 一起使用，所以我们只需保存。
- en: output of C profile and then use a，output of C profile and then use a。package
    called PI prof to call tree that，package called PI prof to call tree that。takes
    the output of C profile and，takes the output of C profile and。converts it into
    data that will that K，converts it into data that will that K，cash K cash Brian
    will。
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: C profile 的输出，然后使用一个叫做 PI prof 的包来调用树，它将 C profile 的输出转换为可以使用的数据。
- en: cash K cash Brian will，stand and so when doing this you met，stand and so when
    doing this you met。with this UI and I'm sorry if you can't，with this UI and I'm
    sorry if you can't。see this you definitely can't see this，see this you definitely
    can't see this。but basically at the left hand side is，but basically at the left
    hand side is。
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: cash K cash Brian 将会存在，因此在进行此操作时，你会遇到这个用户界面，对不起如果你看不到这个，但基本上左侧是。
- en: the profiling data that we would，the profiling data that we would。otherwise
    see and from C profile output，otherwise see and from C profile output。and then
    we can click on some of those，and then we can click on some of those。functions
    on that right side or the left，functions on that right side or the left。
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将会看到的分析数据来自 C profile 输出，然后我们可以点击右侧或左侧的一些功能。
- en: side to update the right side where we，side to update the right side where we。see
    information about collars and，see information about collars and。colleagues including
    the call graph，colleagues including the call graph。right there and the map of
    the collies，right there and the map of the collies。
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 更新右侧的信息，在那里我们可以看到关于同事的信息，包括调用图，以及同事的地图。
- en: on the top now if you limit the view to，on the top now if you limit the view
    to。our own script and clicking around the，our own script and clicking around the。curtain
    functions we can kind of get an，curtain functions we can kind of get an。idea of
    where time is spent this，idea of where time is spent this。
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 在顶部，现在如果你限制视图到我们自己的脚本并点击一些功能，我们可以大致了解时间的花费。
- en: visualization kind of groups modules，visualization kind of groups modules。together
    by color and so when I was，together by color and so when I was。first actually
    profiling this I saw a，first actually profiling this I saw a。lot of blue and you
    can kind of click，lot of blue and you can kind of click。
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 可视化类型的模块组合，通过颜色组合，所以当我第一次实际进行分析时，我看到很多蓝色，你可以点击一下。
- en: through and get a little more，through and get a little more，information and
    you realize or I realize。information and you realize or I realize，that all that
    blue that we see is。that all that blue that we see is，related to logging now we're
    gonna hold。related to logging now we're gonna hold，on to that thought so Kay cash
    grinding。
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 通过查看并获取更多信息，我意识到所有我们看到的蓝色与日志记录相关，现在我们要记住这个想法，所以 Kay cash grinding。
- en: on to that thought so Kay cash grinding，will allow us to get sort of a broad。will
    allow us to get sort of a broad，picture of what's going on and give us。picture
    of what's going on and give us，some visual clues of where to look for。some visual
    clues of where to look for，potential areas of unnecessary time。
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 记住这个想法，所以 Kay cash grinding 允许我们获得一个大致的全貌，并给我们一些视觉线索，以寻找潜在的不必要的时间浪费。
- en: potential areas of unnecessary time，spent and then there's a line profiler。spent
    and then there's a line profiler，package and with this we can kind of。package
    and with this we can kind of，hone in on areas of our code that we。hone in on areas
    of our code that we，were suspicious of so after installing。
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 渲染输出与对齐配置文件，潜在的不必要时间花费，然后有一个行分析器包，通过这个我们可以在代码的可疑区域上深入挖掘。
- en: were suspicious of so after installing，the line profiler you can add the。the
    line profiler you can add the，profile decorator where you want to。profile decorator
    where you want to，profile them and here I'm only a。profile them and here I'm only
    a，decorating with the save Co routine so。
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 我们对此表示怀疑，因此在安装行分析器后，你可以添加装饰器到你想要分析的地方。这里我只是用保存协程来装饰。
- en: decorating with the save Co routine so，the line profiler library comes with
    a。the line profiler library comes with a，CLI tool called Kern prof that we will。CLI
    tool called Kern prof that we will，invoke our script with and then we。invoke our
    script with and then we，render the output with the align profile。
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 用保存协程来装饰，行分析器库附带一个名为 Kern prof 的 CLI 工具，我们将用它来调用我们的脚本，然后我们。
- en: render the output with the align profile，module itself which gives us a。module
    itself which gives us a，line-by-line assessment of our decorated。line-by-line
    assessment of our decorated，code so the total time spent here in。code so the total
    time spent here in，this function is just over two，this function is just over two。
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 渲染输出与对齐配置文件，模块本身给我们提供了逐行评估我们装饰过的。模块本身给我们提供了逐行评估我们装饰过的代码，因此在此函数中花费的总时间刚好超过两。
- en: milliseconds and then majority of that，milliseconds and then majority of that。time
    was spent in logging now if only，time was spent in logging now if only。there was
    something we could do about，there was something we could do about。that coincidentally
    there is someone，that coincidentally there is someone。
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 毫秒，大部分时间花费在日志记录上，现在如果只有我们能做点什么，碰巧的是，有人。
- en: already has done something and so，already has done something and so。there's
    this package called a AO logger，there's this package called a AO logger。and that
    allows for non-blocking logging，and that allows for non-blocking logging。so if
    we switch out our default logger，so if we switch out our default logger。
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 已经做了一些事情，因此有一个名为 AO 日志记录器的包，它允许非阻塞日志记录。因此，如果我们更换默认日志记录器。
- en: with a io logger and rerun the profiler，with a io logger and rerun the profiler。I
    can see that our total time spent on，I can see that our total time spent on。the
    function is halved as well as a time，the function is halved as well as a time。spent
    logging itself and so certainly，spent logging itself and so certainly。
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 IO 日志记录器并重新运行分析器，我可以看到我们在该函数上花费的总时间减半，以及用于日志记录的时间，所以确实。
- en: these are like minuscule improvements，these are like minuscule improvements，that
    we're doing here。that we're doing here，um but you can extrapolate on a much，um
    but you can extrapolate on a much。larger scale and also as I see it if we，larger
    scale and also as I see it if we。have an event loop let's try and make，have an
    event loop let's try and make。
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 这些就像微小的改进，我们在这里所做的。嗯，但你可以在更大范围内推断出来，而且我认为如果我们有一个事件循环，我们就尝试。
- en: so we've profiled a C profile with C，so we've profiled a C profile with C。profile
    in with a line profiler but，profile in with a line profiler but。we've had to stop
    the service in order，we've had to stop the service in order。to look at results
    so perhaps you would，to look at results so perhaps you would。
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 所以我们用 C 进行了一次 C 配置文件的分析，但我们不得不停止服务以查看结果，所以也许你会。
- en: like a live profiler to go along with，like a live profiler to go along with。your
    production debugging there's this，your production debugging there's this。package
    called a profiling that provides，package called a profiling that provides。an interactive
    UI and supports async i/o，an interactive UI and supports async i/o。
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 像一个实时分析器一样与你的生产调试一起， 像一个实时分析器一样与你的生产调试一起。这个包叫做分析， 这个包叫做分析。提供了一个交互式用户界面并支持异步I/O，
    提供了一个交互式用户界面并支持异步I/O。
- en: as well as threads and green LEDs，as well as threads and green LEDs。granted
    you can't attach to a running，granted you can't attach to a running。process with
    this particular tool you'll，process with this particular tool you'll。
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 以及线程和绿色LED， 以及线程和绿色LED。虽然你不能使用这个特定的工具连接到正在运行的， 虽然你不能使用这个特定的工具连接到正在运行的。进程，你将，
    进程，你将。
- en: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_2.png)'
  id: totrans-211
  prefs: []
  type: TYPE_IMG
  zh: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_2.png)'
- en: need to launch your service with it but，need to launch your service with it
    but。when you do you get this text-based UI，when you do you get this text-based
    UI。
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 需要启动你的服务才能使用它，但是， 需要启动你的服务才能使用它。但是，当你这样做时，你会得到这个基于文本的用户界面， 当你这样做时，你会得到这个基于文本的用户界面。
- en: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_4.png)'
  id: totrans-213
  prefs: []
  type: TYPE_IMG
  zh: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_4.png)'
- en: that regularly updates and with this you，that regularly updates and with this
    you。
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 这个工具会定期更新，有了这个你， 这个工具会定期更新，有了这个你。
- en: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_6.png)'
  id: totrans-215
  prefs: []
  type: TYPE_IMG
  zh: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_6.png)'
- en: can drill down and pause when you're，can drill down and pause when you're。inspecting
    something and then restart it，inspecting something and then restart it。
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 当你检查某样东西时，可以深入并暂停，然后重新启动， 当你检查某样东西时，可以深入并暂停，然后重新启动。
- en: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_8.png)'
  id: totrans-217
  prefs: []
  type: TYPE_IMG
  zh: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_8.png)'
- en: when you're ready you're also able to，when you're ready you're also able to。just
    save the performance data and view，just save the performance data and view。
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 当你准备好时，你也能够， 当你准备好时，你也能够。保存性能数据并查看， 保存性能数据并查看。
- en: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_10.png)'
  id: totrans-219
  prefs: []
  type: TYPE_IMG
  zh: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_10.png)'
- en: it with this UI at a later time and then，it with this UI at a later time and
    then。what's actually kind of cool is it，what's actually kind of cool is it。provides
    a server so that you can，provides a server so that you can。remotely connect to
    it from elsewhere，remotely connect to it from elsewhere。
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在稍后的时间使用这个用户界面，然后， 你可以在稍后的时间使用这个用户界面，然后。其实有点酷的是，它提供了一个服务器， 实际上有点酷的是，它提供了一个服务器。这样你可以从其他地方远程连接，
    这样你可以从其他地方远程连接。
- en: and so the TLDR profiling there's，and so the TLDR profiling there's。basically
    not much difference with，basically not much difference with。profiling async IO
    code from non async，profiling async IO code from non async。IO code and it can
    be confusing though，IO code and it can be confusing though。
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 所以TLDR分析就是这样，TLDR分析就是这样。基本上与非异步代码的分析没有太大区别，基本上与非异步代码的分析没有太大区别。异步IO代码的分析可能会令人困惑，异步IO代码的分析可能会令人困惑。
- en: with just looking at the output of from，with just looking at the output of from。C
    profile so to get initial picture of，C profile so to get initial picture of。your
    services performance using C，your services performance using C。profile with K
    cache grind can help，profile with K cache grind can help。
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 仅仅通过查看C配置文件的输出， 仅仅通过查看C配置文件的输出。以获得你的服务性能的初步概况， 以获得你的服务性能的初步概况。使用C进行分析， 使用C进行分析。与K缓存磨损一起分析可以帮助，
    与K缓存磨损一起分析可以帮助。
- en: surface areas to investigate without，surface areas to investigate without。that
    visualization it can be difficult，that visualization it can be difficult。to identify
    hotspots but then once we do，to identify hotspots but then once we do。have some
    sort of idea of where hotspots，have some sort of idea of where hotspots。
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
  zh: 有待调查的表面区域， 有待调查的表面区域。那种可视化可能很困难， 那种可视化可能很困难。识别热点，但一旦我们做到这一点， 识别热点，但一旦我们做到这一点。对热点有某种了解，
    对热点有某种了解。
- en: are you can use a line profiler to get a，are you can use a line profiler to
    get a。line-by-line performance data and then，line-by-line performance data and
    then。finally if you want to profile with，finally if you want to profile with。production
    data I would take I would，production data I would take I would，suggest，suggest。
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以使用行分析器来获取， 你可以使用行分析器来获取。逐行性能数据，然后， 逐行性能数据，然后。最后，如果你想用，最后，如果你想用。生产数据进行分析，我建议，
    生产数据进行分析，我建议。
- en: taking a look at the profile package，taking a look at the profile package。profiling
    package alright that was a lot，profiling package alright that was a lot。but in
    essence this talk is something，but in essence this talk is something。that I would
    have liked to have like，that I would have liked to have like。
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 看一下配置文件包，看看配置文件包。性能分析包，好吧，这涉及很多内容，性能分析包，好吧，这涉及很多内容。但实际上，这次演讲是我想要的，实际上，这次演讲是我想要的。
- en: three years ago so I'm kind of talking，three years ago so I'm kind of talking。to
    pass Lin here but I'm hoping that，to pass Lin here but I'm hoping that。someone
    else or you all have some，someone else or you all have some。benefit from this
    use case that is not a，benefit from this use case that is not a。
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: 三年前，我就想这样说，所以我有点像是在传达给Lin，但我希望，像其他人或者你们能从这个用例中受益，这个用例并不是一个。
- en: web crawler so um I know it's lunchtime，web crawler so um I know it's lunchtime。but
    I will be around here through all，but I will be around here through all。the conference
    as well as the sprints so，the conference as well as the sprints so。if you have
    questions you can come find，if you have questions you can come find，me but thank
    you。
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 网络爬虫，所以我知道现在是午餐时间，网络爬虫，所以我知道现在是午餐时间。但我会在这里待着，贯穿整个会议以及冲刺阶段，所以，贯穿整个会议以及冲刺阶段。如果你有问题，可以来找我，但谢谢你。
- en: me but thank you。
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 谢谢你。
- en: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_12.png)'
  id: totrans-229
  prefs: []
  type: TYPE_IMG
  zh: '![](img/70c5fa474cb4ff7321ee8fd9410d75b7_12.png)'
