# P31：Talk Dean Wampler - Ray A System for High-performance, Distributed Python Applic - 程序员百科书 - BV1rW4y1v7YG

![](img/fbab452e2807ba666077f18f101b6fb1_0.png)

各位，这是迪恩·万珀，来自任何规模，我将讨论如何将 Python应用程序从笔记本电脑扩展到集群，这里有一堆链接，你可以在任何比例尺网站的院长那里和我联系，或者在迪安万珀的推特上。你可以在任何天平上找到更多关于雷的信息，今年夏天我们确实有一些在线活动，你可以去任何规模的网络斜杠活动 了解更多关于这些，演讲结束后 我会提供这些幻灯片，雷的动机确实反映了我们行业的几个趋势。

这是左边的一张图，因为它们在过去五六年里的进化，基本上它们一直在进化，你知道吗，三倍的倍数，每十八个月五次，相比之下，摩尔定律每两个月，所以你知道，仅仅扩展硬件对我们来说是不行的。我们需要分布式计算来满足需求，同时，由于对ml ai和其他数据科学工作负载的兴趣，Python在很大程度上受到这种语言的驱动，因此Python继续强劲增长，所以一起。

这两个趋势确实为我们创造了一个迫切的需求，使在集群上分发python应用程序变得更加容易，为了满足这些对可伸缩性的需求，同时也便于 python开发人员访问和使用，所以如果你看看今天的 ML景观。你知道你有很多任务要做，特性化就像找出你的数据的哪些方面对做预测最有用，或者任何我们经常用数据流实时处理数据的东西，我将讨论超参数调优，为什么这很重要 稍后你需要超参数 tunis来选择最好的模型结构。

一旦我们有了它，然后我们要训练我们的模特，你经常像游戏模拟器或其他类型的模拟器一样运行，当你训练完这些模特之后，那你就得伺候他们，几乎所有这些都需要一个分布式的实现来有效地扩展。尤其是当你在这张图的中间，所以阵列的愿景是创建一个核心框架，可以满足这些不同类型的计算负载的所有需求，最初的目标是蟒蛇，但它实际上足够灵活，可以支持其他语言，例如。

有一种alpha质量的java实现或api正在开发中，最重要的是，我们希望有特定领域的库，所以你可能根本不知道你在利用雷，你只需要使用这些库，但如果你写的是通用应用程序，你可能真的想知道雷的事。让我们看看实际使用光线是什么感觉 它被设计成尽可能直观和简洁，利用熟悉的想法，所以他们中的一个，当然，是用 python编写函数，这是，你知道吗，一个模拟的例子，这里我们有一些函数make array。

返回一个numpy array，然后一些函数添加数组，可以将两个数组添加到一起，所以这很熟悉，如果你知道蟒蛇，这应该不难弄清楚，如果你想把这些变成分布式任务，我们用的术语是。您所要做的就是用 ray remote注释这些函数，然后它们就可以通过光线自动在集群中执行，为完整起见，如果这个代码能正常工作，您必须进行一些导入，然后在应用程序中初始化数组，所以另一个区别是。

现在通过附加一个远程函数来调用它们，使数组现在就调用它们，如果python有足够的延展性，我们就可以用参数列表来表示make array。但我们把遥控器放在这里的原因是 这样就可以很容易地阅读代码 来确切地知道发生了什么，所以它确实需要更多的代码更改，但你知道，正如我所说，比起编写代码，你更倾向于阅读代码。

所以我们觉得最好在这里设置遥控器作为一个指示器，说明什么是射线特异性的，什么是一般的蟒蛇，但实际情况是你发送了一个异步计算来完成这个任务，它立即返回一个id，这个id实际上对应于一个未来。我们以后可以用它来检索这个计算的结果，1号就是这样，我们可以再来一次，然后我们可以调用这个远程函数来添加我们完成后的结果，然后我们用这个函数来检索这个计算中的值，如果我们只关心三号身份证。

我们不用去找另外两个，尽管我们可以，这是一个封锁电话，会的，你知道一个街区直到三号身份证可用，然后它将返回标识3点的对象，在这种情况下，一个麻木的数组。现在最酷的事情之一是 雷正在处理这些依赖关系的排序，在两个make数组调用完成之前，它不能运行ad数组，它就会自动为我们做到这一点，所以我们不需要用逻辑来解释，你也知道，检查他们是否完成了，再这样处理。

它只是为我们做的，所以它知道右边的这个图，它会自动处理，另一个好处是，由于add数组是远程的，我们不必从这些未来的句柄中提取数组，为了通过它们来添加数组，雷在幕后自动为我们做这件事。所以它有点像我们编写常规 python代码的方式，我们真的不必知道这些是一些人的身份证，未来与实际阵列的对比，当然你需要知道在某些时候，尤其是在最后一行，那么分布式状态呢，不好意思。

所以当你在编写一个分布式应用程序的时候 你经常会遇到这样的问题，我如何管理现在分布在集群上的状态，为此，我们利用了python中一个熟悉的概念，叫做类，希望大家都熟悉，在本例中，我有一个简单的计数器类。它跟踪一个值，每次我打电话给增量公司，它，将该值递增1，然后很好地返回当前值，再一次，你用遥控器注释它，现在变成演员了，为什么演员这个词好，五岁，在jvm世界，它因airlang语言的商业实现而闻名。

有啊，还有其他的实现方法，你的想法是你有这些自主代理人，你通过给他们发信息来与他们交流，不管是为了工作还是为了得到价值什么的，然后环境提供一个线程安全的执行模型，一次一个，这些消息被处理。所以它们被保存在某个地方的队列中，这意味着参与者实现的编写者不必担心线程安全代码，他们只是写常规代码，而 actor模型为您处理线程安全，所以这是一个非常强大的并发性模型，它。

它对编写线程安全代码的许多复杂性进行了抽象，所以现在我们有一个远程演员，现在你需要做的是，Ray目前不支持仅仅读取对象内部字段的值，因此，如果仅仅捕获increment的值还不够。就必须编写getter方法，好的，所以实际发生的事情，我们用我们的远程通话，注意它是如何用于构造函数和这些方法调用的，然后我们也可以用一系列的 ID来调用 rai get，嗯。

这个雷达远程功能实际上需要一堆可选的参数来指定一些东西，比如你想使用多少个GPU，在不允许更多调用之前，您可以调用这个函数多少次，诸如此类的事情，好的，那么这个是如何工作的呢，所以我在这里提到。我发现了一个三节点集群，我们一会儿会讨论这些盒子在做什么，但基本上我们要看看这个任务图是如何安排在像这样的集群中的，一旦我们做了这些函数调用，会安排好的，调用本地调度程序来进行计算。

现在它将立即返回那些身份证，你知道这些是异步计算，所以它们的叫声马上就回来了，我们还有一个全球控制存储，它跟踪所有东西的位置，以及发生了什么，因此。调度程序可能会选择本地工作人员执行第一个make数组调用，它可能会在另一个节点上选择另一个工人来做另一个，一旦每个任务完成，它会写下它的结果，它的对象返回到对象存储，现在这些任务可以从工作内存中删除了。

这和演员有一点不同，实际上演员是固定在工人身上的，因为他们持有状态，在驱动程序代码中对它们的引用消失之前，它们会留在工人体内，现在我们可以安排我们的广告阵列，它可以从共享内存读取对象1。它不需要将对象复制到工作者的内存空间中。所以这很方便，如果一个物体很大，它有助于性能，现在对象2不在同一个节点上，所以这个必须复制，有一点开销，显然这样做，但现在它可以从共享内存中读取，也是。

当添加数组完成时，它将结果写回对象存储，当我们打电话给雷，得到全球控制存储 告诉我们它在哪里，我们的代码返回目标三，就这样，所以这是一个，你知道吗，在幕后为你做了很多工作，很明显。所有这些东西都有一点管理费用，所以你不想使用细粒度的任务，因为你会招致开销，那是，你知道吗，只是没有给你那么多的价值，但这对于完成所有这些异步工作来说是很棒的。

即使是在分布式集群上使用大对象的非常大的计算，好吧，假设你想和雷扯上关系，你可能想调查一下，首先从 RAIO开始，在那里你可以找到我们的博客，文件链接等，下一个链接实际上是文档。在那里你可以找到关于安装射线开始等等的细节，我们正在开发新的教程 在我们所谓的任何规模的学院，这些将于今年夏天出版，其实这个春夏，如果你想看强奸项目的代码，这是链接，如果你需要帮助。

最好的地方是光线松弛，我们非常仔细地监控它，经常帮助那里的人，还有一个光线发展，一群人，如果你更喜欢交谈 而不是电子邮件，好吧，假设你想收养雷，你当然可以直接开始编程射线。但是您可能已经在使用其他 apis编写代码了，好吧，我们已经实现了用于异步的 apis，I，O，joblib和多处理池，所以你可以顺便来看看，在大多数情况下，只需通过更改 import语句进入数组。

你不仅有相同的，你知道吗，本地模式或本地节点计算，但现在你打破了界限，你可以的，通过这种替换，你基本上可以将你的应用程序扩展到一个集群，在我们的雷博客上有几个博客链接，如果你去电台。您可以访问这些博客文章，并找到更多关于如何做到这一点的信息，对，今天我只谈其中的两个，是啊，再一次，这里有几个，tune是用于超参数的，调谐射线，SGD是我们刚刚推出的产品，那就是它帮助分配训练。

另一个新图书馆是，先生，为模特服务，所以让我们来谈谈每分钟的自由空间，这个想法很简单，尽管很明显幕后有很多复杂的东西，你有某种代理人在一个环境中行动，它在观察发生了什么，这是，它也在决定下一步该做什么。然后观察它采取这些行动得到了什么回报，目标是在这个环境中的一系列步骤中优化奖励，一些著名的例子是阿尔法围棋系统打败了世界上最好的围棋手，它被用来玩 atari游戏，训练模拟机器人，嗯，甚至像模拟步行者。

教他们走路，你知道吗，阿尔法变得更复杂或非常复杂，如你所料，在幕后有一个大的神经网络帮助做出决定，所以在这种情况下，动作是把石头放在哪里，神经网络试图给你最好的选择，奖励很简单，要么赢 要么输。我们也看到了，在优化工业流程方面 有很多有趣的工作正在做，比如工厂的地板和管道等等，优化网络计算，这类事情它被用作一种新的方式来做广告服务和推荐，得到广泛的传播，一些规模问题，用传统方法和金融，也是。

你知道吗，很明显，股票市场是一个，你知道吗，计时系统，所以无论你在构建什么应用程序，你会做很多架构上的决定 比如，不管是一个特工还是多个合作的特工，或者他们的等级制度，离线批量有点有趣，我们的想法是。我不能让你一遍又一遍地经营我的化工厂，但我确实有大量的过去表现记录，我们能训练对抗吗，我为所有这些选择，然后给你一系列的算法，全部由雷执行，呃，下面是 rl lib中许多可用的算法的图表。

这些都是当你得到这篇演讲的pdf文件时，你可以点击的链接，如果你是亚马逊的客户，你甚至可以在sagemaker中运行它，现在，事实上，你可能在运行一个模拟器，就像一个游戏引擎。一个机器人模拟工厂的模拟器什么的，这更像是一个典型的面向对象的应用程序，或者任何具有非常不同的复杂图形和内存的应用程序，这些图表的不同访问模式，不同的计算等等，这不是你传统的数据处理问题。

你只有大量的数据集，在系统中进行查询或转换，或者任何非常不同的计算模型，你也在做我们一直在优化的所有常规神经网络的事情，像张量流和 pi火炬这样的系统，你得一遍又一遍地重复这个，因为如果你愿意。你会继续玩这个游戏，直到你找到一个最佳配置，使回报最大化，因此，你需要能够有效地做到这一点，等等，所以有各种各样的，这里的一系列挑战，现有的系统中没有一个，伯克利正在处理的问题真的可以解决。

所以他们发明了射线，让我们讨论超参数调优和用于进行此操作的调优库，所以超参数调优实际上是要求，什么是最好的型号 我应该使用，超参数告诉你，我能想到的最简单的例子就是 k和 k的聚类。这是一个 k等于3的例子，在那里你知道，一旦我选了 k，然后我会迭代一个相对简单的算法来找到我的数据集中的集群，如你所知，看这个右边移动的例子，你可以看到有两个相当明显的星系团，再多一个无定形的星团。

所以 k等于3是对的，如果你在处理二维数据，你可以经常绘制它，看看它，看看最好的选择是什么，但是如果你要处理三维之外的多维数据，也许是非常复杂的结构，这就不那么容易了。所以有时候你只需要用不同的 k值多次运行这种聚类算法 就能找到最好的 k值，这就是超参数调优的真正意义，找到那个结构，再训练模特，告诉你实际的参数，在这种情况下是群集，好吧，你知道吗。

找到 k和 k的意思并不是一个极具挑战性的问题，有点贵，可能是在计算，但真正具有挑战性的是 当你研究像神经网络这样的东西时，你在这里看到的每一个数字，什么类型的层是超参数，显然你可以做出巨大的选 择。当你试图为一个问题选择最好的神经网络时，所以超参数调优的想法是优化搜索过程，这样你就可以得到最好的网络，或者一个表现相当好的网络，你知道吗，浪费了大量的计算，试图找到它，有关系，你知道吗，这是一个例子。

你知道吗，用不同的超参数运行猎豹模拟器，蓝色做得最好，在这种情况下，粉红色做得最差，因此，它确实起到了作用，并作为一种工具出现，帮助您在资源昂贵的情况下找到最佳模型，就像，GPU，例如。用于神经网络训练，而且做训练也很费时间，你想优化所有这些东西，所以当你尝试了很多不同的模型结构，看看哪一个是最好的，tune会处理分布式的训练，它利用了很多幕后的算法和工具 比如 pytorch。

张量流，Scikit，它试图让你很容易地声明你想做什么，然后去做，然后曲调做剩下的工作，它和张量板结合在一起，所以你可以看到你的超参数是什么样子的，就像我们提到的，这就是问题所在。你知道它有资源感知调度，你知道你可以告诉它在哪里，它做了一个非常无缝的分布式执行，你真的不必知道幕后发生了什么，你只知道外面有一群人在做你的工作，在 API中添加新算法和新工具相对简单。

所以它就像一把雨伞，它是框架 不可知论者，它支持许多流行的框架，这里是tune文档的链接，在ray，阅读文件，IO站点，作为微服务的通用工具，不管你现在在建立什么样的服务。我知道微服务现在受到了一点反弹，你可能听过优步有句名言，他们要去宏观服务，你知道吗，除了什么是正确的规模为您的服务，总体思路仍然有效，你只需要聪明地使用它，建立微服务有几个原因，只是为了坚持这个术语。

一种是他们划分域，它通常以两种方式划分，一种是接受康威定律，我稍后会解释我的意思，另一个只是把责任分开，比如让网络团队担心 dns解决方案，安全团队担心身份验证，那种东西。在生产中对这些东西的管理也是一个重要的驱动力，所以康威定律，这是梅尔·康威在60年代的观察，他注意到系统的架构通常反映了构建它们的结构的组织，换句话说，就像子系统倾向于反映大团队中的团队或子组织。

我们实际上决定我们应该接受，我们应该组织我们的团队来反映我们正在建立的系统的结构，以及这样做的原因，或者一开始发生这种情况的原因是我们想尽量减少我们必须在组织之外进行的交流，因为这对人们来说是一个负担。因为有太多的沟通渠道要维护，它让我们把，你知道吗，在一个较小的团队里，所需的高保真通信量，显然，我刚才提到了几个例子，你希望你的微服务有一个最小的，就像，希望它能很好地完成一项责任。

它与其他微服务有一个自然的最小耦合，希望也能反映出团队的组织，但我真正要做的是，对于雷是管理上的挑战，在devops世界中，开发团队还负责运行和操作他们的微服务是很常见的，你知道在某个由，整个组织。您通常看到的是，每个微服务实际上拥有与其他微服务不同数量的实例，如果你知道，这些例子会以不同的速度来来去去，正如我在这张图上所展示的，微服务3可能不需要那么多实例，但假设它实际上发展得更快。

必须更频繁地更新，你知道另外两个可能更稳定，但是它们的负载需要更多的实例，这是一个有点负担，你知道为什么我们这里有这么多的例子，好吧，有两个原因，一是我们，我们可能需要它们来提高可伸缩性。因为你知道我们达到了一个节点的极限，因此我们必须访问更多的节点，从而访问更多的实例，它还有助于弹性，如果我们有，你知道吗，至关重要的微服务，它只在一个节点上运行，当节点崩溃的时候，我们会有麻烦的。

所以弹性是另一个原因，雷赋予我们的能力是，你知道这是一种九十九式的解决方案，我不想假装这是魔法，但因为雷可以在幕后利用整个集群，它可以追溯到这样一个想法，即对于我们运行的每个微服务。我们确实有一个逻辑实例，我们让雷处理我们后面的可伸缩性，这也与像 kubernetes这样的集群系统很好地吻合，你知道吗，如果你想到一个集装箱和库伯尼特，真的像个小机器，就像雷可以利用，你知道吗。

物理硬件，它是一个更细粒度的调度系统，可以在一个更大的调度系统的构造中工作，像 kubernetes，所以总结一下，Ray是最新的分布式计算系统，嗯，这是，呃，你知道吗。我们相信从你的笔记本电脑上运行的东西出发的最短路径，在云中运行的东西，在一堆机器上，或者在您的环境中的本地硬件中，呃，它有足够的灵活性，可以运行各种各样的计算任务和内存访问模式。

任何规模的公司都是从伯克利分拆出来的，开源系统，为了围绕它开发产品和服务，我们实际上正在招聘，即使在我们生活的这个 COVID时代，你可以在任何规模上找到更多，DOT，COM，很不幸我不能回答问题。但这里有更多的链接给你，RAIO是获取雷信息的地方，了解有关，你知道我们的职位空缺，了解像我们的夏季比赛峰会连接系列这样的事件，这些是我们正在做的在线活动，五月嗯，我们要去参加原定于，5月，现在开始了。

最有可能发生在11月，我非常欢迎你来找我，任何规模的学院院长，尤其是如果你想要幻灯片，我会试着让他们可用，但我还不确定它们会被贴在哪里，所以请随时联系我 在院长 在任何规模的网站，非常感谢。
![](img/fbab452e2807ba666077f18f101b6fb1_2.png)