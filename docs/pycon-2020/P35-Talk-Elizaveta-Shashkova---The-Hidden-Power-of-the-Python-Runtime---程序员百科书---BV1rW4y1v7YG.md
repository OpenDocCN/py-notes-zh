# P35：Talk Elizaveta Shashkova - The Hidden Power of the Python Runtime - 程序员百科书 - BV1rW4y1v7YG

![](img/b871d77e57ecbf4f5dfd6d7ad239084e_0.png)

我叫伊丽莎白托沙科娃，今天我想向我的狗狗展示金字塔隐藏的力量，我是个软件开发人员，我在喷气大脑工作，我做调试器已经好几年了，现在我专注于 Pyar的科学特征，目前我位于俄罗斯城市，在圣彼得堡。在我家录制了这次演讲，所以让我们开始，Python语言简单美观，但其中很大一部分语言力量是对用户隐藏的，并且仅在运行时 仅在执行期间可用，你甚至可能不知道，但你已经每天都在使用这种隐藏的力量，例如。

我们每天都做测试，让我们比较两种在 python标准模块单元测试中常用的方法，或者非常流行的测试框架，要看出它们之间的区别，最简单的方法是执行某个语句，万一失败，单元测试将报告断言异常。我们将向您展示它发生的地方，就像任何其他例外一样，但通过测试，我们将向您展示关于值的详细信息，你试图比较，1。我从哪儿弄来的？这些信息，当然，从运行时，今天在这个演讲中。

我们将学习 python运行时如何工作，python如何允许检查当前程序状态，以及如何在不同的开发工具中使用运行时信息，让我们从学习 python运行时的基本概念开始，在py中。有一个流行的短语说一切都是一个对象，这意味着每一个变量甚至不仅仅是一个简单的记忆片段，但是一个具有值和相关操作的复杂实体，这种基于对象的本质是真的，不仅适用于核心类型，如数字、字符串、集合或其他东西。

但对于像函数这样的程序单元对象也是如此，类甚至模块，所有这些类型的对象都被显式声明，当您使用赋值语句时，解释器创建您的对象，或者当您声明一个带有聋人关键字的新函数时。或者当用 class关键字声明一个新类时，但在行刑过程中，Python解释器不仅创建您在代码中明确定义的对象，它还创建了许多表示执行过程的对象，其中一个关键是，呃，其中的对象是一个堆栈框架。

堆栈框架对象表示 python中的程序作用域，此对象包含有关当前执行状态的信息，就像一个代码对象，本地和全局变量，很多其他的数据帧存储在一个类似雄鹿的结构中，最底层的框架，有时被称为模块框架。表示从其开始执行的模块，在这个例子中，执行流程在7号线，它将调用函数，当 python解释器在执行期间进入新的作用域时，它创建新的框架对象，然后，当执行过程留下这段代码时，将它放在其他帧的堆栈上。

在我们的例子中，函数表单解释器的返回，从顶部移除框架对象，并将一些数据传递到前一帧，前一帧的执行继续进行到第8行，就这样，这是一个非常粗略的描述，但主要的想法是这样的，事实上，这个运行时机器。所有堆栈的概念对许多其他编程语言来说是相同的，但它们和蟒蛇的主要区别在于，没有多少语言包含这种开箱即用的运行时信息，在python框架中，对象可以作为通常的python对象访问，写你的程序。

你可以从中检索到很多有趣的信息，在下一部分，我们将学习如何做到这一点，我们如何检查内部执行状态，正如我们在前一部分所讨论的，执行过程的概念是程序的任何地方的堆栈帧，您可以通过调用函数获得当前堆栈帧。从标准模块获取框架，此函数从当前线程的调用堆栈中返回一个框架对象，它有一个可选的参数 深度，它确定堆栈中的深度，即顶部以下有多个调用，所以如果你把0传递给这个函数，您将得到当前的框架对象。

让我们检查哪些信息存储在框架对象中，首先，框架对象包含一个字典，其中包含当前作用域的局部变量，如果你定义一些变量，你可以通过它的名字访问它，只是一本普通的字典，您可以迭代它。但是不能从 python代码更新它，只可能从 c，我也给你框架对象访问全局变量字典，当我们讨论全局变量时，我们指的是当前模型的全局变量，现在我们知道如何获得关于定义变量的信息了，但说实话。

我们不需要框架对象来获得这些信息，因为有内置的功能，当地人和全球人，返回完全相同的字典，好消息是变量，字典并不是存储在框架对象中的唯一有趣的信息，第二个有趣的东西是代码对象，它也被存储为框架属性。代码对象表示一块可执行代码，但它不同于函数对象，因为它不包含对全局执行环境的引用，创建代码对象的最简单方法是调用内置函数，编译编译代码，也可以通过将对象传递给内置的函数演化过程来评估对象。

你可以在这里看到一个例子，我们的代码对象有一个声称的值，避孕套也包含了很多信息，它是创建这个对象的文件名，定义函数或模块的名称，在这个作用域中使用的变量名称列表，它还包含一个字节码对象，在函数的帮助下。一个可执行语句序列这个来自标准模块这个，您甚至可以拆解它，并读取由解释器生成的注释，代码对象包含更多的属性，但这些对我们今天来说是最重要的，让我们回到一个框架对象，除了变量和代码。

对象帧还存储有关当前行号的信息，正在执行，它存储一个跟踪函数，帮助跟踪当前帧中的事件，我们稍后会讨论，它还存储了到前一帧的链接，如你所记，帧存储在类似于数据结构的堆栈中。检查当前帧状态的最简单方法是迭代，完毕，它们与前一帧的链接，异常追溯正是这样工作的，你的程序中出现了一个异常，如果不是处理 为什么，然后把这些漂亮的痕迹袋输入输出。

所以你可以理解你是如何到达程序框架中的这个地方的，对象及其之间的链接，是一种机制 它可以帮助你获得这些信息并展示给你，除非它只是存储在框架对象中的最重要的信息，但不是所有的信息。在检测标准模块中实现了许多有用的功能，它有一整组独立的函数 用于检查解释器栈，但是当你使用框架变量时，你应该记住一件重要的事情，你不应该忘记删除这个变量，当你离开望远镜的时候，否则。

您可以创建一个引用周期，这些物体会存活更长时间，它会导致后期对象的破坏 甚至内存消耗，在这部分，我们了解到当我们编写和执行 python代码时，我们甚至可能不考虑隐式生成了多少有趣的对象。我们的源代码很好，但是我们如何在日常生活中使用它呢？下一部分将了解不同的开发工具如何使用这些信息，帮助你变得更有效率，当您使用 python代码时，你还记得在演讲开始的时候，我们已经了解到偏见。

可以显示出一定的误差与准确的值进行了比较，现在，我们有足够的知识来理解它是如何实施的，让我们创建自己的工具，它将显示在第三个语句中使用的变量的值，异常对象将跟踪返回对象存储在。追溯属性和追溯包含了我们最重要的，对象框架对象，我们已经知道是否可以访问框架对象，我们知道关于程序状态的一切，我们的函数将是这样的，它将异常对象作为参数，从异常对象，我们就能从画面中得到线索。

我们可以得到代码对象，从代码对象我们可以得到，例如源代码，我们知道发生异常的行号，我们有一个源代码，所以在标准模块 asd的帮助下，我们可以得到在这一行中使用的变量名称，我没有向你们展示这个函数。您可以在我的存储库中找到它的源代码和示例，我将在演讲的最后分享这个链接，这意味着我们可以找到这些名字的变量值，因为我们有一个在框架对象中包含局部变量的字典，这就是它的工作原理。

我们可以用下面的方法使用我们的函数，在异常处理期间，我们应该将异常对象传递给我们的新函数，它将输出变量的值，即使没有它也会很有帮助的，例如，用于伐木，如果堆栈跟踪不够。您可以自动记录在失败的断言语句中使用的所有变量的值，把所有这些信息，当然，它可以扩展到任何其他异常时间，因此，正如您所看到的关于python运行时的知识，你可以创造一些很酷的工具，当然。

我们的函数比偏置实现的函数要强大得多，但主要的想法非常非常相似，第二个依赖于运行时的是调试器，正如我在演讲开始时已经说过的，我在 pycharms调试器上工作了好几年。为什么我知道这么多信息隐藏在框架对象中，调试器是使用这些信息的主要工具之一，如今，买家基于两个主要功能之一，跟踪功能和框架评估功能，当跟踪函数被设置，为了框架，程序中发生的每个事件都会被调用。

需要三个论点，框架和弧形，如果指定了跟踪函数，frame对象在 f trace属性中存储到它的链接，基于跟踪函数的窃听器，分析到达跟踪函数的程序中的事件，把程序悬置在用户放置断点的地方。功能框架有以下签名，在框架开始执行之前，正在执行一个公式函数，基于帧演化函数的 bug，将断点代码插入到帧代码对象中，我们不打算讨论这个问题，现在是内部的了，如果你想了解更多。

请随时观看我在图标 我们217的演讲，用 python三六调试，但我们现在感兴趣的是，这两个函数都将框架对象作为参数，我们在前一部分学到的东西，帮助买家展示使用框架对象的信息。抢劫犯是如何理解执行是否达到了断点的，并在编辑器变量西班牙中突出显示相应的行，在那里您可以看到，局部变量基于框架 f局部变量字典，您在后台会话中看到的帧列表。

也是通过遍历 frame f back属性从 frame对象接收的，如你所见 信息存储在帧中，帮助买家工作，并向您展示当前程序状态的信息，但也有一些其他的娃娃，另一个工具是代码覆盖率。代码覆盖率帮助您了解代码库中的哪些行是在运行期间执行的，并检查，例如，他们是否有任务在身，这是一个非常重要的工具，因为它能让你确信你的代码库已经得到了很好的开发和维护，最流行的代码覆盖率库是。

它有一个非常可爱的吉祥物，昏昏欲睡的咬伤覆盖率，圆点圆周率是基于相同的跟踪功能，我们已经在调试器中看到了，如你所知，跟踪函数接受三个参数，其中一个是框架物体。由于框架对象覆盖工具可以收集关于文件名和行号的信息，然后在你的报道中展示给你看，我们讨论了测试代码覆盖率中的调试器，但是还有另一组基于运行时信息的工具，在程序 execu期间收集类型信息的工具。

然后帮助您在源代码中生成类型注释，我发现了三种工具的信息，但可能会有更多的人，Piannotate by Dropbox，收集函数参数的类型，然后将类型注释插入到代码中。Instagram的 monkey ai也做了类似的事情，它收集有关您的参数类型的信息，然后为您的项目生成停止文件，根据这些收集到的信息，选项通过魅力收集可获得的及时信息，ID也做了类似的事 情。

如果启用此选项，调试器开始收集关于每个函数的类型信息，稍后如果你想通过通道为某个函数生成狗串，将在狗串生成过程中使用收集到的信息，这三个工具都使用运行时信息。让我们了解它们是如何通过注释和 monkey类型实现的，两者都是基于 cdot集配置文件，它与轮廓函数一起工作，与追踪功能非常相似，它需要完全相同的三个论点，但这并不是你的上帝的每一句话都能抓住的。

只有当您调用某个函数或方法时，才会调用它，这是合乎逻辑的，因为对于跟踪函数参数，你需要潮流，只呼叫事件，不是你节目里的每个乐队，我已经说过了，在 python中收集运行时信息与调试器集成。所以它还可以访问一个框架对象，那么我们如何得到参数的类型，如果我们能访问框架对象，首先，我们可以得到在当前框架中定义的参数名称列表，因为所有的东西都存储在一个代码对象中，我们已经看到了这个代码对象。

在我开始演讲的时候，你还记得，我们有一个带有局部变量的字典，所以我们可以接触到，因此他们的类型，所以对于每个函数，我们已经知道变量的名字了，他们的类型，地点，哪里这个，确定了职能，我们可以存储这些信息。然后将其用于类型，说明，世代，所有这些工具都是这样实现的，借助框架对象和相应的代码对象，我们讨论了几种基于 python中运行时信息的工具，但它们都很复杂，让我们试着创造一些小但有用的东西。

我们自己的工具，也是基于运行时信息，帮助我们发现问题，例如，在并发执行中，有两种方法可以并发执行任务，在一个蟒蛇过程中，线程，以及借助标准模块线程的异步任务，您可以启动一个新线程。它将并发地执行您的功能，用于 python中线程之间的同步，有同步对象，最基本的同步对象是锁对象，线程可以获取锁定对象，这意味着下面的代码块将由，只有通过这条线索，直到它释放这个日志对象。

Python锁对象也是上下文管理器，所以你可以和他们一起工作，运行多个线程和使用本地对象 有时会导致死锁，当国家陷入僵局时，当多个线程正在等待无法释放的资源时，要重现这种情况，最简单的方法如下。创建线程来锁定对象，并以不同的顺序获取锁定对象，第一个线程获得锁1，第二个线程获得第二个锁，第一个线程想要获取日志2，但它是不可用的，所以它开始等待，第二个线程想要获取日志1号，但它也是不可用的。

正如您所看到的，这种情况可以在没有程序中断的情况下得到解决，因为老鼠会永远等着它们的本地物品，这是非常可悲的，如果你有一个很大的代码库，可能很难检测到登录代码，即使是代码分析也帮不了你。因为死锁发生在代码执行期间的运行时，但是我们已经知道了很多关于 python运行时的有趣的事情，我们可以试着在这里应用它们，我们已经用了这个点得到帧函数，返回当前读线程的框架对象。

但还有另一个有用的函数 cdot电流帧，它为当前 python进程中的每个线程返回最上面的堆栈帧，这个功能最酷的地方是它能工作，即使有死锁的线程，在此功能的帮助下，我们可以创造自己的工具。这将是打印跟踪盒的线程与一些内部，帮助我们找到线卡住的地方，在狗身上，就这样简单有力 工具准备好了，但是有一个问题，这个功能已经在故障处理程序模块内的标准库中实现了，它有一个功能。

它将所有运行线程的跟踪袋带到一个文件中，在 c代码中补充了它，但不是所有的事情都在我们面前实现，如你所记，还有一种方法可以并发地执行一些代码，在单个迷彩中也有非常相似的同步对象，因此。一个同步的数据日志可以出现在你的神，这意味着有一个地方我们可以应用我们的新知识，Python运行时，并创建一个同步版本的故障处理程序，几个有用的功能已经在一个 cayo模块中实现了，第一个是异步任务。

在一个循环中返回所有正在运行的任务，第二个是任务方法卡住了，返回此任务的帧列表，我们的接收器故障处理程序是这样工作的，在一个单独的线程中，我们在一个循环中运行，在一定时间内，我们现在转储任务追踪袋。如果我们怀疑代码中的某个地方存在同步死锁，我们可以用我们的异步故障处理程序快速检查它，找到一个僵局出现的地方，我们实现了一个简单但强大的工具来检测死日志，使用异步任务，这是我们今天要考虑的最后一个工具。

在这部分，我们学习了几种基于程序运行时信息的工具，我想再次强调，这些工具收集信息，仅仅从源代码是不可能得到的，您可以根据源代码做出一些假设，但只有在运行时 我们才能得到变量的真实值和真实的程序状态。这是基于运行时开发的非常酷的特性，今天我们学到了很多关于 python运行时的知识，正如我们在谈话中所看到的，信息可用于开发过程的任何部分，在测试期间，在调试期间，即使在并行代码执行期间。

我希望在这次演讲之后，您将开始更经常地使用运行时开发工具，因为它们确实有助于编写更可靠的代码，例如，发现拳击要快得多，也许你会创造你自己的，你，在这次谈话之后，你已经有足够的信息了。如果你愿意的话 那就太好了，如果你决定做实验，以下是一些链接，包含今天示例的存储库，源代码，当然可以随便看蟒蛇，关于我们今天使用的任何标准模块的官方文件，我也很乐意在视频评论中回答你们的问题。

或通过电子邮件，或者在我的推特账户里。
![](img/b871d77e57ecbf4f5dfd6d7ad239084e_2.png)